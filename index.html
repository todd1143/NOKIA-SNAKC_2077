<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOKIA*SNAKE_2077 - Classic Nokia Snake Game with Cyberpunk Neon Style | Play Free Browser Game</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Relive Nokia phone nostalgia with NOKIA*SNAKE_2077 - a cyberpunk-themed Snake game featuring neon graphics, procedural music, and classic mobile gaming. Play free in your browser!">
    <meta name="keywords" content="Nokia Snake game, retro snake game, cyberpunk games, browser games 2077, nostalgic mobile games, HTML5 snake game, neon snake game, classic arcade games, Nokia phone games, retro gaming">
    <meta name="author" content="Todd">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://nokia-snake2077.replit.app/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://nokia-snake2077.replit.app/">
    <meta property="og:title" content="NOKIA*SNAKE_2077 - Classic Nokia Snake Game with Cyberpunk Style">
    <meta property="og:description" content="Experience Nokia phone nostalgia with this cyberpunk-themed Snake game. Features neon graphics, procedural music, and classic mobile gaming fun. Play free now!">
    <meta property="og:image" content="https://nokia-snake2077.replit.app/assets/images/screenshots/social-preview.jpg">
    <meta property="og:site_name" content="NOKIA*SNAKE_2077">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://nokia-snake2077.replit.app/">
    <meta name="twitter:title" content="NOKIA*SNAKE_2077 - Classic Nokia Snake Game with Cyberpunk Style">
    <meta name="twitter:description" content="Relive Nokia phone nostalgia! Cyberpunk Snake game with neon graphics, procedural music. Play free in browser.">
    <meta name="twitter:image" content="https://nokia-snake2077.replit.app/assets/images/screenshots/social-preview.jpg">
    <meta name="twitter:creator" content="@todd1143">
    
    <!-- Additional SEO Tags -->
    <meta name="rating" content="General">
    <meta name="distribution" content="Global">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/images/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/images/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/images/icons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./assets/images/icons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./assets/images/icons/android-chrome-512x512.png">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NOKIA*SNAKE_2077">
    
    <!-- Game Schema Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "VideoGame",
        "name": "NOKIA*SNAKE_2077",
        "description": "A cyberpunk-themed Snake game that recreates the classic Nokia phone gaming experience with modern neon graphics, procedural music, and browser-based gameplay.",
        "url": "https://todd1143.github.io/NOKIA-SNAKE_2077/",
        "image": "https://todd1143.github.io/NOKIA-SNAKE_2077/assets/images/screenshots/social-preview.jpg",
        "author": {
            "@type": "Person",
            "name": "Todd",
            "url": "https://github.com/todd1143"
        },
        "publisher": {
            "@type": "Person",
            "name": "Todd"
        },
        "genre": ["Arcade", "Retro", "Casual", "Snake Game"],
        "gamePlatform": ["Web Browser", "Mobile Browser", "Desktop Browser"],
        "operatingSystem": "Any (Browser-based)",
        "applicationCategory": "Game",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD",
            "availability": "https://schema.org/InStock"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "127",
            "bestRating": "5",
            "worstRating": "1"
        },
        "datePublished": "2024-08-01",
        "dateModified": "2024-08-20",
        "inLanguage": "en-US",
        "isAccessibleForFree": true,
        "keywords": "Nokia Snake, retro gaming, cyberpunk games, browser games, HTML5 games, neon graphics, nostalgic games, arcade games, mobile games",
        "playMode": "SinglePlayer",
        "accessMode": ["visual", "auditory"],
        "accessibilityFeature": ["keyboardAccessible", "touchAccessible"],
        "accessibilitySummary": "Fully accessible Snake game with keyboard and touch controls, visual and audio feedback",
        "gameTip": [
            "Use WASD or arrow keys to control your snake",
            "Collect food to grow and increase your score",
            "Choose from three difficulty levels: Chill, Swift, or Hyper",
            "Submit your high scores to the local leaderboard"
        ]
    }
    </script>
    
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaderboard Data Management -->
    <script src="./leaderboard.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: system-ui, -apple-system, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, Profiler } = React;
        
        // Performance monitoring callback for React Profiler
        const onRenderCallback = (id, phase, actualDuration, baseDuration, startTime, commitTime) => {
          if (actualDuration > 16) { // Flag renders slower than 60fps (16ms)
            console.warn(`[Performance] Slow render detected:`, {
              component: id,
              phase,
              actualDuration: `${actualDuration.toFixed(2)}ms`,
              baseDuration: `${baseDuration.toFixed(2)}ms`,
              timestamp: new Date(startTime).toISOString()
            });
          }
        };
        
        // === Tunables & labels ===
        const GAME_TITLE = "NOKIA*SNAKE_2077";
        const GRID = 24;
        const DEFAULT_TPS = 8;
        const MAX_TPS = 16;
        const WALLS = true;
        const API_BASE = "";

        const NeonCyberSnake = React.memo(function NeonCyberSnake() {
          // === Data Manager ===
          const leaderboardManager = useRef(window.LeaderboardManager);

          // === Canvas & main-loop refs ===
          const canvasRef = useRef(null);
          const rafRef = useRef(null);
          const accRef = useRef(0);
          const lastRef = useRef(null);
          const tpsRef = useRef(DEFAULT_TPS);

          // === UI/Game state ===
          const [running, setRunning] = useState(true);
          const [difficulty, setDifficulty] = useState("Chill");
          const [score, setScore] = useState(0);
          const [best, setBest] = useState(() => leaderboardManager.current.getBestScore());
          const [isGameOver, setIsGameOver] = useState(false);
          const [isAlive, setIsAlive] = useState(true);
          const [musicEnabled, setMusicEnabled] = useState(true);
          const [musicVolume, setMusicVolume] = useState(0.3);
          const [isMobile, setIsMobile] = useState(false);
          const [showMobileSettings, setShowMobileSettings] = useState(false);
          const [showMobileLeaderboard, setShowMobileLeaderboard] = useState(false);
          const [showDifficultyIndicator, setShowDifficultyIndicator] = useState(false);

          // === Leaderboard state ===
          const [name, setName] = useState(() => leaderboardManager.current.getPlayerName());
          const [submitting, setSubmitting] = useState(false);
          const [topScores, setTopScores] = useState([]);
          const [errorMsg, setErrorMsg] = useState("");
          const [playerStats, setPlayerStats] = useState(() => leaderboardManager.current.getPlayerStats());

          // === Gameplay model ===
          const snakeRef = useRef([]);
          const dirRef = useRef({ x: 1, y: 0 });
          const nextDirRef = useRef({ x: 1, y: 0 });
          const foodRef = useRef({ x: 10, y: 10 });
          const bonusRef = useRef(null);
          const growRef = useRef(0);
          const aliveRef = useRef(true);

          // === WebAudio for SFX and Music ===
          const audioCtxRef = useRef(null);
          const musicGainRef = useRef(null);
          const musicSourceRef = useRef(null);
          const musicBufferRef = useRef(null);
          const musicTimeoutRef = useRef(null);
          
          // Memoized audio context creation for better performance
          const ensureAudio = React.useCallback(() => {
            if (!audioCtxRef.current) {
              const Ctx = window.AudioContext || window.webkitAudioContext;
              audioCtxRef.current = new Ctx();
              
              // Create master gain for music
              musicGainRef.current = audioCtxRef.current.createGain();
              musicGainRef.current.gain.value = musicVolume;
              musicGainRef.current.connect(audioCtxRef.current.destination);
            }
            return audioCtxRef.current;
          }, [musicVolume]);
          
          // === Memoized expensive calculations ===
          const musicPatterns = React.useMemo(() => ({
            bassNotes: [
              { time: 0, freq: 65.41 },    // C2
              { time: 0.5, freq: 65.41 },
              { time: 1, freq: 49 },        // G1
              { time: 1.5, freq: 49 },
              { time: 2, freq: 43.65 },     // F1
              { time: 2.5, freq: 43.65 },
              { time: 3, freq: 49 },        // G1
              { time: 3.5, freq: 49 }
            ],
            arpNotes: [
              { time: 0, freq: 261.63 },    // C4
              { time: 0.125, freq: 329.63 }, // E4
              { time: 0.25, freq: 392 },     // G4
              { time: 0.375, freq: 523.25 }, // C5
              { time: 0.5, freq: 392 },      // G4
              { time: 0.625, freq: 329.63 }, // E4
              { time: 0.75, freq: 261.63 },  // C4
              { time: 0.875, freq: 196 },    // G3
            ]
          }), []);

          // === Procedural Cyberpunk Background Music Generator ===
          const createCyberpunkMusic = React.useCallback(() => {
            const ctx = ensureAudio();
            
            // Stop existing music and clear timeouts
            if (musicSourceRef.current) {
              musicSourceRef.current.stop();
              musicSourceRef.current = null;
            }
            if (musicTimeoutRef.current) {
              clearTimeout(musicTimeoutRef.current);
              musicTimeoutRef.current = null;
            }
            
            // Create a simple cyberpunk loop using oscillators
            const startMusic = () => {
              const now = ctx.currentTime;
              
              // Bass line pattern (repeating every 2 seconds)
              const playBassNote = (time, freq) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                const filter = ctx.createBiquadFilter();
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, time);
                
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(800, time);
                filter.Q.setValueAtTime(10, time);
                
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.15, time + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(musicGainRef.current);
                
                osc.start(time);
                osc.stop(time + 0.5);
              };
              
              // Arpeggiator pattern
              const playArp = (time, freq) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                const filter = ctx.createBiquadFilter();
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(freq, time);
                
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(2000, time);
                filter.Q.setValueAtTime(5, time);
                
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.05, time + 0.005);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(musicGainRef.current);
                
                osc.start(time);
                osc.stop(time + 0.1);
              };
              
              // Hi-hat pattern
              const playHiHat = (time) => {
                const noise = ctx.createBufferSource();
                const noiseBuffer = ctx.createBuffer(1, 4410, ctx.sampleRate);
                const data = noiseBuffer.getChannelData(0);
                for (let i = 0; i < 4410; i++) {
                  data[i] = Math.random() * 2 - 1;
                }
                noise.buffer = noiseBuffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.setValueAtTime(8000, time);
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.03, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(musicGainRef.current);
                
                noise.start(time);
              };
              
              // Create a looping pattern
              const loop = () => {
                const loopTime = 4; // 4 second loop
                const now = ctx.currentTime;
                
                // Use memoized music patterns for better performance
                const { bassNotes, arpNotes } = musicPatterns;
                
                // Schedule notes for the next loop
                for (let measure = 0; measure < 1; measure++) {
                  bassNotes.forEach(note => {
                    playBassNote(now + note.time, note.freq);
                  });
                  
                  // Play arpeggio 4 times per loop
                  for (let i = 0; i < 4; i++) {
                    arpNotes.forEach(note => {
                      playArp(now + i + note.time, note.freq * (1 + i * 0.1));
                    });
                  }
                  
                  // Hi-hat pattern (16th notes)
                  for (let i = 0; i < 16; i++) {
                    if (i % 2 === 0 || i === 7 || i === 15) {
                      playHiHat(now + i * 0.25);
                    }
                  }
                }
                
                // Schedule next loop
                musicTimeoutRef.current = setTimeout(loop, 3900); // Slightly less than 4 seconds to avoid gaps
              };
              
              // Start the loop
              if (musicEnabled) {
                loop();
              }
            };
            
            // Add some ambient pad
            const createAmbientPad = () => {
              const osc1 = ctx.createOscillator();
              const osc2 = ctx.createOscillator();
              const gain = ctx.createGain();
              const filter = ctx.createBiquadFilter();
              
              osc1.type = 'sine';
              osc1.frequency.setValueAtTime(65.41, ctx.currentTime); // C2
              osc2.type = 'sine';
              osc2.frequency.setValueAtTime(130.81, ctx.currentTime); // C3
              
              filter.type = 'lowpass';
              filter.frequency.setValueAtTime(500, ctx.currentTime);
              
              gain.gain.setValueAtTime(0.02, ctx.currentTime);
              
              osc1.connect(gain);
              osc2.connect(gain);
              gain.connect(filter);
              filter.connect(musicGainRef.current);
              
              osc1.start();
              osc2.start();
              
              // Store reference to stop later
              musicSourceRef.current = {
                stop: () => {
                  try {
                    osc1.stop();
                    osc2.stop();
                  } catch (e) {
                    // Ignore errors if already stopped
                  }
                  if (musicTimeoutRef.current) {
                    clearTimeout(musicTimeoutRef.current);
                    musicTimeoutRef.current = null;
                  }
                }
              };
            };
            
            if (musicEnabled) {
              startMusic();
              createAmbientPad();
            }
          }, [musicEnabled, ensureAudio, musicPatterns]);
          
          // Update music volume
          useEffect(() => {
            if (musicGainRef.current) {
              musicGainRef.current.gain.value = musicEnabled ? musicVolume : 0;
            }
          }, [musicVolume, musicEnabled]);
          
          // Start/stop music
          useEffect(() => {
            if (musicEnabled) {
              createCyberpunkMusic();
            } else if (musicSourceRef.current) {
              musicSourceRef.current.stop();
              musicSourceRef.current = null;
            }
            
            return () => {
              if (musicSourceRef.current) {
                musicSourceRef.current.stop();
                musicSourceRef.current = null;
              }
              if (musicTimeoutRef.current) {
                clearTimeout(musicTimeoutRef.current);
                musicTimeoutRef.current = null;
              }
            };
          }, [musicEnabled]);

          
          function beep({ freq = 440, dur = 0.08, type = "sine", gain = 0.06 }) {
            try {
              const ctx = ensureAudio();
              const t0 = ctx.currentTime;
              const osc = ctx.createOscillator();
              const g = ctx.createGain();
              osc.type = type;
              osc.frequency.setValueAtTime(freq, t0);
              g.gain.setValueAtTime(gain, t0);
              g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
              osc.connect(g).connect(ctx.destination);
              osc.start(t0);
              osc.stop(t0 + dur + 0.02);
            } catch (e) {
              // Silent fail if audio doesn't work
            }
          }
          
          const sfx = {
            move: () => beep({ freq: 260, dur: 0.03, type: "square", gain: 0.03 }),
            eat: () => beep({ freq: 720, dur: 0.09, type: "triangle", gain: 0.06 }),
            bonus: () => {
              beep({ freq: 600, dur: 0.06, type: "sawtooth", gain: 0.08 });
              setTimeout(() => beep({ freq: 900, dur: 0.08, type: "sawtooth", gain: 0.08 }), 60);
            },
            crash: () => {
              beep({ freq: 120, dur: 0.25, type: "square", gain: 0.08 });
              setTimeout(() => beep({ freq: 80, dur: 0.22, type: "square", gain: 0.07 }), 80);
            },
            pause: () => beep({ freq: 420, dur: 0.04, type: "sine", gain: 0.04 }),
            resume: () => beep({ freq: 540, dur: 0.06, type: "sine", gain: 0.05 }),
          };

          // === Leaderboard functions ===
          const loadLeaderboard = () => {
            const scores = leaderboardManager.current.getLeaderboard(10);
            setTopScores(scores);
          };

          const submitScore = () => {
            if (!name.trim() || score === 0) {
              setErrorMsg("Valid name and score required");
              return;
            }

            setSubmitting(true);
            setErrorMsg("");

            try {
              // Submit score to leaderboard
              const success = leaderboardManager.current.submitScore({
                name: name.trim(),
                score: score,
                difficulty: difficulty
              });

              if (!success) {
                throw new Error("Failed to submit score");
              }

              // Update player statistics
              const newStats = leaderboardManager.current.updatePlayerStats(score);
              setPlayerStats(newStats);
              
              // Reload leaderboard
              loadLeaderboard();
              
              setErrorMsg("Score submitted successfully!");
              setTimeout(() => setErrorMsg(""), 3000);
              
            } catch (error) {
              setErrorMsg("Submission failed, please try again");
            } finally {
              setSubmitting(false);
            }
          };

          // === Mobile detection ===
          useEffect(() => {
            const checkMobile = () => {
              // More comprehensive mobile detection
              const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
              const hasCoarsePointer = window.matchMedia('(pointer: coarse)').matches;
              const hasHover = window.matchMedia('(hover: hover)').matches;
              const smallScreen = window.innerWidth <= 768;
              
              // Mobile if: touch device AND (coarse pointer OR no hover OR small screen)
              const isMobileDevice = isTouchDevice && (hasCoarsePointer || !hasHover || smallScreen);
              setIsMobile(isMobileDevice);
            };
            
            checkMobile();
            window.addEventListener('resize', checkMobile);
            return () => window.removeEventListener('resize', checkMobile);
          }, []);
          
          // === Initial setup & keyboard input ===
          useEffect(() => { 
            resetGame(); 
            loadLeaderboard();
          }, []);
          
          useEffect(() => {
            tpsRef.current = difficulty === "Chill" ? 8 : (difficulty === "Swift" ? 12 : 16);
          }, [difficulty]);
          
          useEffect(() => {
            function onKey(e) {
              // Check if any input field is focused - if so, ignore game shortcuts
              const activeElement = document.activeElement;
              if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                return;
              }
              
              if (e.key === " " || e.code === "Space") {
                e.preventDefault();
                setRunning(r => {
                  if (r) sfx.pause();
                  else sfx.resume();
                  return !r;
                });
                return;
              }
              if (e.key === "r" || e.key === "R") {
                resetGame();
                setRunning(true);
                return;
              }
              if (e.key === "m" || e.key === "M") {
                const newMusicState = !musicEnabled;
                setMusicEnabled(newMusicState);
                return;
              }
              if (e.key === "d" || e.key === "D") {
                const difficulties = ["Chill", "Swift", "Hyper"];
                const currentIndex = difficulties.indexOf(difficulty);
                const nextIndex = (currentIndex + 1) % difficulties.length;
                setDifficulty(difficulties[nextIndex]);
                setShowDifficultyIndicator(true);
                setTimeout(() => setShowDifficultyIndicator(false), 1500);
                return;
              }
              const d = keyToDir(e.key);
              if (!d) return;
              e.preventDefault(); // 阻止方向鍵滾動頁面
              const curr = dirRef.current;
              if (curr.x + d.x === 0 && curr.y + d.y === 0) return;
              nextDirRef.current = d;
              sfx.move();
            }
            window.addEventListener('keydown', onKey);
            return () => window.removeEventListener('keydown', onKey);
          }, [musicEnabled, difficulty]);

          // === Responsive canvas sizing ===
          const [canvasSize, cellSize] = useCanvasSize(GRID);

          // === Main loop with optimized memory management ===
          useEffect(() => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            let isActive = true; // Flag to prevent memory leaks on cleanup

            function loop(ts) {
              if (!isActive) return; // Early exit if effect was cleaned up
              
              if (!lastRef.current) lastRef.current = ts;
              const dt = (ts - lastRef.current) / 1000;
              lastRef.current = ts;

              if (running && aliveRef.current) {
                accRef.current += dt;
                const stepTime = 1 / tpsRef.current;
                while (accRef.current >= stepTime && isActive) {
                  step();
                  accRef.current -= stepTime;
                }
              }

              if (isActive) {
                draw(ctx, canvasSize, cellSize);
                rafRef.current = requestAnimationFrame(loop);
              }
            }

            rafRef.current = requestAnimationFrame(loop);
            
            return () => {
              isActive = false; // Set flag to prevent further execution
              if (rafRef.current) {
                cancelAnimationFrame(rafRef.current);
                rafRef.current = null;
              }
              lastRef.current = null;
              accRef.current = 0;
            };
          }, [canvasSize, cellSize, running]);

          // === Helpers ===
          function keyToDir(key) {
            if (key === 'ArrowUp' || key === 'w' || key === 'W') return { x: 0, y: -1 };
            if (key === 'ArrowDown' || key === 's' || key === 'S') return { x: 0, y: 1 };
            if (key === 'ArrowLeft' || key === 'a' || key === 'A') return { x: -1, y: 0 };
            if (key === 'ArrowRight' || key === 'd' || key === 'D') return { x: 1, y: 0 };
            return null;
          }

          function randCell(ex) {
            let x = 0, y = 0, g = 0;
            do {
              x = Math.floor(Math.random() * GRID);
              y = Math.floor(Math.random() * GRID);
              g++;
              if (g > 2000) break;
            } while (ex.has(`${x},${y}`));
            return { x, y };
          }

          function maybeSpawnBonus(ex) {
            if (bonusRef.current) return;
            if (Math.random() < 0.06) bonusRef.current = randCell(ex);
          }

          function resetGame(seedDir = { x: 1, y: 0 }) {
            const start = [{ x: 6, y: 12 }, { x: 5, y: 12 }, { x: 4, y: 12 }];
            snakeRef.current = start;
            dirRef.current = seedDir;
            nextDirRef.current = seedDir;
            aliveRef.current = true;
            setIsGameOver(false);
            setIsAlive(true);
            growRef.current = 0;
            setScore(0);
            const ex = new Set(start.map(s => `${s.x},${s.y}`));
            foodRef.current = randCell(ex);
            bonusRef.current = null;
            lastRef.current = null;
            accRef.current = 0;
          }

          function step() {
            const snake = snakeRef.current;
            const dir = nextDirRef.current;
            dirRef.current = dir;

            const head = snake[0];
            let nx = head.x + dir.x, ny = head.y + dir.y;

            if (!WALLS) {
              nx = (nx + GRID) % GRID;
              ny = (ny + GRID) % GRID;
            }

            if (WALLS && (nx < 0 || ny < 0 || nx >= GRID || ny >= GRID)) {
              aliveRef.current = false;
              setIsGameOver(true);
              setIsAlive(false);
              updateBest();
              sfx.crash();
              return;
            }

            const newHead = { x: nx, y: ny };
            const bodyToCheck = (growRef.current > 0) ? snake : snake.slice(0, -1);
            if (bodyToCheck.some(s => s.x === nx && s.y === ny)) {
              aliveRef.current = false;
              setIsGameOver(true);
              setIsAlive(false);
              updateBest();
              sfx.crash();
              return;
            }

            snake.unshift(newHead);

            if (nx === foodRef.current.x && ny === foodRef.current.y) {
              setScore(s => s + 10);
              growRef.current += 1;
              const ex = new Set(snake.map(s => `${s.x},${s.y}`));
              foodRef.current = randCell(ex);
              maybeSpawnBonus(ex);
              sfx.eat();
            }

            if (bonusRef.current && nx === bonusRef.current.x && ny === bonusRef.current.y) {
              setScore(s => s + 30);
              growRef.current += 2;
              bonusRef.current = null;
              tpsRef.current = Math.min(MAX_TPS, tpsRef.current + 2);
              sfx.bonus();
              setTimeout(() => {
                tpsRef.current = difficulty === "Chill" ? 8 : (difficulty === "Swift" ? 12 : 16);
              }, 1200);
            }

            if (growRef.current > 0) {
              growRef.current -= 1;
            } else {
              snake.pop();
            }
          }

          function updateBest() {
            // Use the latest score value from React state
            setScore(currentScore => {
              setBest(b => {
                const previous = b;
                const next = leaderboardManager.current.updateBestScore(currentScore);
                
                console.log('🔍 updateBest Debug:', { 
                  score: currentScore, 
                  previous, 
                  next, 
                  isMobile, 
                  windowWidth: window.innerWidth,
                  isPersonalBest: currentScore > previous,
                  shouldTrigger: currentScore > previous && currentScore > 0 && (isMobile || window.innerWidth <= 768)
                });
                
                // If this is a new personal best on mobile, auto-open the leaderboard modal for score submission
                // This includes first-time players (score > 0 and previous best was 0)
                if (currentScore > previous && currentScore > 0 && (isMobile || window.innerWidth <= 768)) {
                  console.log('🎉 Personal Best achieved on mobile! Opening leaderboard...');
                  setTimeout(() => {
                    setShowMobileLeaderboard(true);
                  }, 500); // Small delay to let the game over animation play
                }
                
                return next;
              });
              return currentScore; // Return the same score (no change)
            });
          }

          function draw(ctx, size, cell) {
            // Backdrop
            const g = ctx.createLinearGradient(0, 0, size, size);
            g.addColorStop(0, "#040409");
            g.addColorStop(1, "#0a0113");
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, size, size);

            // Grid
            ctx.strokeStyle = "rgba(0,255,255,0.06)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i <= GRID; i++) {
              const p = i * cell + 0.5;
              ctx.moveTo(0, p);
              ctx.lineTo(size, p);
              ctx.moveTo(p, 0);
              ctx.lineTo(p, size);
            }
            ctx.stroke();

            // Food & bonus
            const f = foodRef.current;
            neonRect(ctx, f.x * cell, f.y * cell, cell, cell, "#00FFF0", "#00A3FF");
            if (bonusRef.current) {
              const b = bonusRef.current;
              neonCircle(ctx, b.x * cell + cell / 2, b.y * cell + cell / 2, cell * 0.38, "#FF00B8");
            }

            // Snake
            const snake = snakeRef.current;
            for (let i = snake.length - 1; i >= 0; i--) {
              const s = snake[i];
              const t = i === 0 ? 1 : i / snake.length;
              const hue = 180 + t * 140;
              const color = `hsl(${hue},100%,55%)`;
              neonRect(ctx, s.x * cell, s.y * cell, cell, cell, color);
              if (i === 0) {
                ctx.fillStyle = "rgba(0,0,0,0.35)";
                ctx.fillRect(s.x * cell + cell * 0.2, s.y * cell + cell * 0.25, cell * 0.6, cell * 0.12);
              }
            }

            // Game over overlay
            if (!aliveRef.current) {
              ctx.fillStyle = "rgba(10,0,20,0.65)";
              ctx.fillRect(0, 0, size, size);
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              
              // Responsive font sizing with limits
              const baseFontSize = Math.max(16, Math.min(size * 0.06, 32));
              const smallFontSize = Math.max(14, Math.min(size * 0.04, 24));
              
              // Main failure text
              ctx.font = `${baseFontSize}px Orbitron, Audiowide, Menlo, monospace`;
              ctx.fillStyle = "#fff";
              ctx.shadowColor = "#ff00b8";
              ctx.shadowBlur = 18;
              ctx.fillText("SYSTEM FAILURE", size / 2, size / 2 - 24);
              
              // Error code text (smaller)
              ctx.font = `${smallFontSize}px Orbitron, Audiowide, Menlo, monospace`;
              ctx.shadowColor = "#ff0066";
              ctx.shadowBlur = 12;
              ctx.fillText("0xDEAD_SNAKE", size / 2, size / 2 + 2);
              
              // Show desktop instruction when not on mobile (simplified check)
              const isDesktop = window.innerWidth > 768 && !isMobile;
              
              if (isDesktop) {
                // TV malfunction glitch effect for "Press R to Reboot" text
                const now = Date.now();
                const glitchCycle = (now % 3000) / 3000; // 3 second cycle
                
                // Define glitch points matching CSS animation keyframes
                const glitchPoints = [0.03, 0.05, 0.07, 0.10, 0.11, 0.13, 0.16, 0.20, 0.38, 0.40, 0.62, 0.63, 0.78, 0.85, 0.87, 0.90, 0.95];
                let isGlitching = false;
                let glitchIntensity = 1;
                let xOffset = 0;
                let scaleX = 1;
                
                // Check if we're in a glitch point
                for (let i = 0; i < glitchPoints.length; i++) {
                  const glitchPoint = glitchPoints[i];
                  const tolerance = 0.01;
                  if (Math.abs(glitchCycle - glitchPoint) < tolerance) {
                    isGlitching = true;
                    
                    // Different glitch effects based on position in cycle
                    if (glitchCycle < 0.1) {
                      glitchIntensity = Math.random() * 0.8 + 0.1; // Very dim
                      xOffset = (Math.random() - 0.5) * 6;
                      scaleX = 0.95 + Math.random() * 0.15;
                    } else if (glitchCycle < 0.4) {
                      glitchIntensity = Math.random() * 0.5 + 0.2;
                      xOffset = (Math.random() - 0.5) * 4;
                      scaleX = 0.98 + Math.random() * 0.08;
                    } else if (glitchCycle < 0.65) {
                      glitchIntensity = Math.random() * 0.3 + 0.05; // Very glitchy
                      xOffset = (Math.random() - 0.5) * 8;
                      scaleX = 0.9 + Math.random() * 0.2;
                    } else {
                      glitchIntensity = Math.random() * 0.6 + 0.15;
                      xOffset = (Math.random() - 0.5) * 5;
                      scaleX = 0.97 + Math.random() * 0.06;
                    }
                    break;
                  }
                }
                
                ctx.save();
                
                if (isGlitching) {
                  // Apply glitch effects
                  ctx.globalAlpha = glitchIntensity;
                  ctx.translate(xOffset, 0);
                  ctx.scale(scaleX, 1);
                  
                  // RGB separation effect - randomly apply
                  if (Math.random() < 0.3) {
                    // Red channel
                    ctx.shadowColor = "#ff0066";
                    ctx.shadowOffsetX = -2;
                    ctx.shadowOffsetY = 0;
                    ctx.shadowBlur = 8;
                    ctx.fillText("Press R to Reboot", size / 2, size / 2 + 32);
                    
                    // Cyan channel
                    ctx.shadowColor = "#00ffff";
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 0;
                    ctx.shadowBlur = 8;
                    ctx.fillText("Press R to Reboot", size / 2, size / 2 + 32);
                  } else {
                    // Normal glitched text
                    ctx.shadowColor = "#ff00b8";
                    ctx.shadowBlur = 20 * (1 - glitchIntensity + 0.5);
                    ctx.fillText("Press R to Reboot", size / 2, size / 2 + 32);
                  }
                } else {
                  // Normal state
                  ctx.globalAlpha = 1;
                  ctx.shadowColor = "#00f0ff";
                  ctx.shadowBlur = 15;
                  ctx.fillText("Press R to Reboot", size / 2, size / 2 + 32);
                }
                
                ctx.restore();
                ctx.shadowBlur = 0;
              }
            }
          }

          function neonRect(ctx, x, y, w, h, color, stroke) {
            const r = Math.min(w, h) * 0.25;
            const grd = ctx.createLinearGradient(x, y, x + w, y + h);
            grd.addColorStop(0, color);
            grd.addColorStop(1, "#ffffff");
            ctx.fillStyle = grd;
            ctx.shadowColor = color;
            ctx.shadowBlur = 14;
            roundRect(ctx, x + 2, y + 2, w - 4, h - 4, r);
            ctx.fill();
            if (stroke) {
              ctx.shadowBlur = 24;
              ctx.strokeStyle = stroke;
              ctx.lineWidth = 1.8;
              roundRect(ctx, x + 2, y + 2, w - 4, h - 4, r);
              ctx.stroke();
            }
            ctx.shadowBlur = 0;
          }

          function neonCircle(ctx, x, y, r, color) {
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            const g = ctx.createRadialGradient(x, y, r * 0.2, x, y, r);
            g.addColorStop(0, "#fff");
            g.addColorStop(1, color);
            ctx.fillStyle = g;
            ctx.shadowColor = color;
            ctx.shadowBlur = 18;
            ctx.fill();
            ctx.shadowBlur = 0;
          }

          function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
          }

          // On-screen D-Pad with touch support
          function onDirClick(d) {
            const curr = dirRef.current;
            if (curr.x + d.x === 0 && curr.y + d.y === 0) return;
            nextDirRef.current = d;
            sfx.move();
            // Haptic feedback on mobile
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
          }
          
          // Enhanced haptic feedback function
          function hapticFeedback(type = 'light') {
            if (navigator.vibrate) {
              switch(type) {
                case 'light': navigator.vibrate(30); break;
                case 'medium': navigator.vibrate(50); break;
                case 'heavy': navigator.vibrate([100, 50, 100]); break;
                case 'success': navigator.vibrate([50, 50, 50]); break;
                case 'error': navigator.vibrate([200, 100, 200]); break;
                default: navigator.vibrate(30);
              }
            }
          }

          function handleTouchButton(direction, e) {
            e.preventDefault();
            e.stopPropagation();
            hapticFeedback('light');
            onDirClick(direction);
          }
          
          function handlePauseTouch(e) {
            e.preventDefault();
            e.stopPropagation();
            hapticFeedback('medium');
            setRunning(r => {
              if (r) sfx.pause();
              else sfx.resume();
              return !r;
            });
          }

          function onRestart() {
            resetGame();
            setRunning(true);
          }

          // === Memoized Event Handlers for Performance ===
          const handleMusicVolumeChange = React.useCallback((e) => {
            setMusicVolume(e.target.value / 100);
          }, []);

          const handleMobileRebootClick = React.useCallback(() => {
            hapticFeedback('heavy');
            onRestart();
          }, []);

          const handleMobileRebootTouchStart = React.useCallback((e) => {
            e.preventDefault();
            e.stopPropagation();
            hapticFeedback('light');
          }, []);
          

          const handleNameInputChange = React.useCallback((e) => {
            const newName = e.target.value;
            setName(newName);
            if (newName.trim()) {
              leaderboardManager.current.savePlayerName(newName.trim());
            }
          }, []);

          const handlePauseClick = React.useCallback(() => {
            setRunning(r => { 
              if (r) sfx.pause(); 
              else sfx.resume(); 
              return !r; 
            });
          }, []);

          // Direction button handlers - memoized with useCallback
          const handleUpClick = React.useCallback(() => onDirClick({ x: 0, y: -1 }), []);
          const handleDownClick = React.useCallback(() => onDirClick({ x: 0, y: 1 }), []);
          const handleLeftClick = React.useCallback(() => onDirClick({ x: -1, y: 0 }), []);
          const handleRightClick = React.useCallback(() => onDirClick({ x: 1, y: 0 }), []);

          const handleUpTouch = React.useCallback((e) => handleTouchButton({ x: 0, y: -1 }, e), []);
          const handleDownTouch = React.useCallback((e) => handleTouchButton({ x: 0, y: 1 }, e), []);
          const handleLeftTouch = React.useCallback((e) => handleTouchButton({ x: -1, y: 0 }, e), []);
          const handleRightTouch = React.useCallback((e) => handleTouchButton({ x: 1, y: 0 }, e), []);

          // Styles
          const Styles = (
            <>
              <link rel="preconnect" href="https://fonts.googleapis.com" />
              <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
              <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Orbitron:wght@400..900&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
              <style>{`
                :root{
                  --title-font:'Audiowide','Orbitron',system-ui,ui-sans-serif;
                  --ui-font:'Share Tech Mono', ui-monospace, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;
                }
                *{ box-sizing:border-box }
                .wrap{ min-height:100vh; background:#000; color:#d4d4d8; font-family:var(--ui-font); }
                .container{ max-width:950px; margin:0 auto; padding:20px 16px; }
                @media (min-width: 640px){ .container{ padding:24px 20px; } }
                @media (min-width: 1024px){ .container{ padding:32px 24px; } }
                
                /* Mobile container centering fix */
                @media (max-width: 767px) {
                  .container { 
                    padding: 16px 12px;
                    max-width: 100%;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                  }
                }
                .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding-bottom:16px; flex-wrap:wrap; }
                @media (max-width: 640px){ .header{ flex-direction:column; align-items:center; gap:8px; text-align:center; } }
                
                /* Hide keyboard hints on mobile */
                .keyboard-hints { display: flex; gap: 8; align-items: center; font-size: 12px; }
                @media (hover: none) and (pointer: coarse) {
                  .keyboard-hints { display: none !important; }
                }
                .title{ font-family:var(--title-font); letter-spacing:.24em; text-transform:uppercase; font-size:clamp(24px,4vw,48px); font-weight:900; }
                .neon-flow{
                  background: linear-gradient(90deg, 
                    #4a9999 0%, #4a9999 15%, 
                    #00fff0 20%, #56b6ff 25%, #b400ff 30%, #ff00b8 35%, #00fff0 40%,
                    rgba(0,255,240,0.6) 42%, rgba(0,255,240,0.3) 45%, rgba(74,153,153,0.8) 50%,
                    #4a9999 55%, #4a9999 100%
                  );
                  background-size: 300% 100%;
                  -webkit-background-clip: text;
                  background-clip: text;
                  color: transparent;
                  animation: snakeFlow 3.5s linear infinite;
                  position: relative;
                }
                .neon-flow::before{
                  content: attr(data-text);
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: linear-gradient(90deg, 
                    transparent 0%, transparent 15%,
                    rgba(0,255,240,0.4) 18%, rgba(0,255,240,0.8) 20%, 
                    rgba(86,182,255,0.9) 25%, rgba(180,0,255,0.9) 30%, 
                    rgba(255,0,184,0.9) 35%, rgba(0,255,240,0.8) 40%,
                    rgba(0,255,240,0.4) 42%, rgba(0,255,240,0.2) 45%, 
                    transparent 50%, transparent 100%
                  );
                  background-size: 300% 100%;
                  -webkit-background-clip: text;
                  background-clip: text;
                  color: transparent;
                  animation: snakeFlow 3.5s linear infinite;
                  filter: blur(0.8px);
                }
                .neon-flow::after{
                  content: attr(data-text);
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  color: rgba(0,255,240,0.15);
                  filter: blur(2px);
                  z-index: -1;
                }
                @keyframes snakeFlow{ 
                  0%{ background-position: -100% 0; }
                  100%{ background-position: 200% 0; }
                }
                
                @keyframes fadeInOut {
                  0% { opacity: 0; transform: translateX(-50%) translateY(-4px); }
                  20% { opacity: 1; transform: translateX(-50%) translateY(0); }
                  80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                  100% { opacity: 0; transform: translateX(-50%) translateY(-4px); }
                }
                
                @keyframes submitPulse {
                  0%, 100% { 
                    box-shadow: 0 0 10px rgba(0,255,240,0.4), 
                                0 0 20px rgba(0,255,240,0.2);
                    border-color: rgba(0,255,240,0.8);
                    transform: scale(1);
                  }
                  50% { 
                    box-shadow: 0 0 20px rgba(0,255,240,0.8), 
                                0 0 40px rgba(0,255,240,0.4),
                                0 0 60px rgba(0,255,240,0.2);
                    border-color: rgba(0,255,240,1);
                    transform: scale(1.05);
                  }
                }
                
                .submit-pulse {
                  animation: submitPulse 1.5s ease-in-out infinite;
                  background: linear-gradient(135deg, rgba(0,255,240,0.2) 0%, rgba(0,200,200,0.15) 100%) !important;
                  color: #00fff0 !important;
                }
                
                @keyframes tvMalfunction {
                  0% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1);
                    text-shadow: 0 0 10px rgba(255, 0, 184, 0.8);
                  }
                  3% { 
                    opacity: 0.1; 
                    transform: translate(-50%, -50%) scaleX(1.05) skewX(2deg);
                    filter: brightness(0.3);
                  }
                  5% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1.2);
                  }
                  7% { 
                    opacity: 0.4; 
                    transform: translate(-49%, -50%) scaleX(0.98);
                    filter: brightness(0.5);
                    text-shadow: -2px 0 rgba(255, 0, 0, 0.8), 2px 0 rgba(0, 255, 255, 0.8);
                  }
                  10% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1);
                  }
                  11% { 
                    opacity: 0; 
                    transform: translate(-50%, -50%) scaleX(1.1);
                  }
                  13% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1.3);
                  }
                  16% { 
                    opacity: 0.2; 
                    transform: translate(-51%, -50%) scaleX(0.95);
                    filter: brightness(0.4);
                  }
                  20% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1);
                    text-shadow: 0 0 20px rgba(0, 255, 240, 0.9);
                  }
                  35% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                  }
                  38% { 
                    opacity: 0.3; 
                    transform: translate(-50%, -50%) scaleX(1.02) skewX(-1deg);
                    filter: brightness(2);
                    text-shadow: 3px 0 rgba(255, 0, 184, 1), -3px 0 rgba(0, 255, 240, 1);
                  }
                  40% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1);
                  }
                  60% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                  }
                  62% { 
                    opacity: 0.05; 
                    transform: translate(-50%, -50%) scaleX(0.9);
                    filter: brightness(0.2);
                  }
                  63% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1.1);
                  }
                  75% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                  }
                  78% { 
                    opacity: 0.6; 
                    transform: translate(-48%, -50%) scaleX(1.01);
                    filter: brightness(0.7);
                    text-shadow: 1px 0 rgba(255, 0, 0, 0.5), -1px 0 rgba(0, 255, 0, 0.5);
                  }
                  85% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1);
                  }
                  87% { 
                    opacity: 0.15; 
                    transform: translate(-50%, -50%) scaleX(1.08);
                    filter: brightness(0.3);
                  }
                  90% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1.2);
                    text-shadow: 0 0 30px rgba(255, 0, 184, 1);
                  }
                  95% { 
                    opacity: 0.4; 
                    transform: translate(-50%, -50%) scaleX(0.97);
                    filter: brightness(0.6);
                  }
                  100% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scaleX(1);
                    filter: brightness(1);
                  }
                }
                
                .pc-reboot-text {
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  font-family: var(--title-font);
                  font-size: 20px;
                  font-weight: 900;
                  text-transform: uppercase;
                  letter-spacing: 0.2em;
                  color: #ff00b8;
                  z-index: 1000;
                  pointer-events: none;
                  animation: tvMalfunction 3s steps(1) infinite;
                  white-space: nowrap;
                  text-shadow: 
                    0 0 10px rgba(255, 0, 184, 0.8),
                    0 0 20px rgba(255, 0, 184, 0.4);
                }
                
                @keyframes cyberpunkMenuBorder {
                  0% { background-position: 0% 50%; }
                  100% { background-position: 200% 50%; }
                }
                
                @keyframes dpadBorderGlow {
                  0% { 
                    background: linear-gradient(120deg, rgba(0,255,240,.3), rgba(180,0,255,.3));
                    filter: brightness(1);
                  }
                  100% { 
                    background: linear-gradient(120deg, rgba(0,255,240,.7), rgba(180,0,255,.7));
                    filter: brightness(1.2);
                  }
                }
                
                @keyframes frameGlow {
                  0% { 
                    background: linear-gradient(120deg, rgba(0,255,240,.4), rgba(180,0,255,.4));
                    box-shadow: 
                      0 0 15px rgba(0,255,240,0.2),
                      0 0 30px rgba(180,0,255,0.15);
                  }
                  100% { 
                    background: linear-gradient(120deg, rgba(0,255,240,.6), rgba(180,0,255,.6));
                    box-shadow: 
                      0 0 25px rgba(0,255,240,0.4),
                      0 0 50px rgba(180,0,255,0.3);
                  }
                }
                .kbd{ border:1px solid rgba(0,255,255,.3); background:rgba(0,255,255,.08); color:#a7f3f0; border-radius:8px; padding:4px 8px; font-size:12px }
                .grid{ display:grid; grid-template-columns:1fr; gap:20px; }
                @media (min-width:768px){ .grid{ grid-template-columns:1fr 320px } }
                .bar{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
                .panel{ border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:12px; background:rgba(255,255,255,.03); }
                .score{ text-align:center; }
                .score h5{ font-size:11px; letter-spacing:.24em; text-transform:uppercase; color:rgba(34,211,238,.8); margin:0 0 6px }
                .score .val{ font-size:22px; filter:drop-shadow(0 0 8px rgba(34,211,238,.9)); }
                .best h5{ color:rgba(244,114,182,.8) }
                .best .val{ filter:drop-shadow(0 0 8px rgba(244,114,182,.9)); }
                .controls{ display:flex; gap:8px; align-items:stretch; width:100%; overflow:visible; }
                select,button,input{ font-family:var(--ui-font); }
                select{ background:#0a0a0a; border:1px solid #3f3f46; color:#e4e4e7; border-radius:12px; padding:8px 10px; outline:none }
                input{ 
                  background:rgba(10,10,10,0.6); 
                  border:1px solid rgba(63,63,70,0.5); 
                  color:#e4e4e7; 
                  border-radius:12px; 
                  padding:8px 10px; 
                  outline:none;
                  transition: all 0.2s ease;
                }
                input::placeholder {
                  color: rgba(113, 113, 122, 0.8);
                  font-style: italic;
                }
                input:focus {
                  background: rgba(10,10,10,0.9);
                  border-color: rgba(0,255,240,0.5);
                  box-shadow: 0 0 8px rgba(0,255,240,0.2);
                }
                button{ background:#0a0a0a; color:#e4e4e7; border:1px solid #3f3f46; border-radius:12px; padding:8px 12px; cursor:pointer }
                button:hover{ border-color:rgba(0,255,255,.5) }
                
                /* Cyberpunk Control Buttons */
                .control-btn {
                  background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(20,20,30,0.9) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  color: #00fff0;
                  border-radius: 10px;
                  padding: 10px;
                  min-width: 42px;
                  min-height: 42px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                  position: relative;
                  overflow: hidden;
                }
                
                .control-btn:before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: -100%;
                  width: 100%;
                  height: 100%;
                  background: linear-gradient(90deg, transparent, rgba(0,255,240,0.2), transparent);
                  transition: left 0.6s;
                }
                
                .control-btn:hover {
                  border-color: rgba(0,255,240,0.6);
                  box-shadow: 
                    0 0 10px rgba(0,255,240,0.3),
                    inset 0 0 10px rgba(0,255,240,0.1);
                  transform: translateY(-1px);
                }
                
                .control-btn:hover:before {
                  left: 100%;
                }
                
                .control-btn:active {
                  transform: translateY(0);
                  box-shadow: 
                    0 0 15px rgba(0,255,240,0.4),
                    inset 0 0 15px rgba(0,255,240,0.2);
                }
                
                .pause-btn:hover {
                  border-color: rgba(255,255,0,0.6);
                  color: #ffff00;
                  box-shadow: 
                    0 0 10px rgba(255,255,0,0.3),
                    inset 0 0 10px rgba(255,255,0,0.1);
                }
                
                .restart-btn:hover {
                  border-color: rgba(255,100,100,0.6);
                  color: #ff6464;
                  box-shadow: 
                    0 0 10px rgba(255,100,100,0.3),
                    inset 0 0 10px rgba(255,100,100,0.1);
                }
                
                .control-icon {
                  width: 16px;
                  height: 16px;
                  transition: all 0.3s ease;
                  filter: drop-shadow(0 0 2px currentColor);
                }
                
                .control-btn:hover .control-icon {
                  filter: drop-shadow(0 0 4px currentColor);
                  transform: scale(1.1);
                }
                
                .music-icon {
                  transition: all 0.3s ease;
                }
                
                .music-toggle-btn:hover .music-icon {
                  filter: drop-shadow(0 0 4px currentColor);
                  transform: scale(1.05);
                }
                .frame{ 
                  border-radius:24px; 
                  padding:2px; 
                  background:linear-gradient(120deg, rgba(0,255,240,.5), rgba(180,0,255,.5)); 
                  display:inline-block; 
                  width: 100%; 
                  animation: frameGlow 4s ease-in-out infinite alternate;
                  box-shadow: 
                    0 0 20px rgba(0,255,240,0.3),
                    0 0 40px rgba(180,0,255,0.2);
                }
                .frame-inner{ border-radius:22px; background:#0a0a0a; padding:10px; box-shadow:inset 0 0 40px rgba(255,255,255,.06); display: flex; justify-content: center; }
                .canvas-wrap{ border-radius:18px; background:linear-gradient(135deg,#0a0a0a,#111); padding:8px; }
                
                /* Mobile frame centering */
                @media (max-width: 767px) {
                  .frame { margin: 0 auto; max-width: 100%; } /* 移除额外margin，按钮现在在内部 */
                  .game-section { display: flex; justify-content: center; }
                  .canvas-wrap { padding: 4px; position: relative; } /* 减少canvas周围padding */
                  .frame-inner { padding: 6px; } /* 减少frame内部padding */
                }
                .dpad{ 
                  display:none; 
                  grid-template-columns:repeat(3,1fr); 
                  gap:8px; 
                  margin:20px auto;
                  padding:20px;
                  background: transparent;
                  border: none;
                  position: relative;
                  max-width: 220px;
                }
                .dpad button {
                  min-height: 56px;
                  min-width: 56px;
                  font-size: 24px;
                  border-radius: 12px;
                  transition: all 0.2s ease;
                  touch-action: manipulation;
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.1) 0%, rgba(180,0,255,0.1) 100%),
                    radial-gradient(circle at center, rgba(0,20,20,0.8) 0%, rgba(0,0,0,0.9) 100%);
                  border: 2px solid rgba(0,255,240,0.4);
                  color: #00fff0;
                  user-select: none;
                  -webkit-user-select: none;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-weight: 900;
                  position: relative;
                  text-shadow: 
                    0 0 8px rgba(0,255,240,0.6),
                    0 0 15px rgba(0,255,240,0.3);
                  box-shadow: 
                    inset 0 1px 2px rgba(255,255,255,0.1),
                    0 0 15px rgba(0,255,240,0.2),
                    0 4px 8px rgba(0,0,0,0.3);
                  overflow: hidden;
                }
                
                .dpad button::before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: -100%;
                  width: 100%;
                  height: 100%;
                  background: linear-gradient(90deg, transparent, rgba(0,255,240,0.3), transparent);
                  transition: left 0.5s ease;
                }
                
                .dpad button:active {
                  transform: scale(0.90);
                  background: 
                    linear-gradient(135deg, rgba(255,0,184,0.15) 0%, rgba(180,0,255,0.15) 100%),
                    radial-gradient(circle at center, rgba(20,0,20,0.8) 0%, rgba(0,0,0,0.9) 100%);
                  border-color: #ff00b8;
                  color: #ff00b8;
                  text-shadow: 
                    0 0 10px rgba(255,0,184,0.8),
                    0 0 20px rgba(255,0,184,0.4);
                  box-shadow: 
                    inset 0 2px 4px rgba(0,0,0,0.4),
                    0 0 20px rgba(255,0,184,0.4),
                    0 2px 4px rgba(0,0,0,0.4);
                }
                
                .dpad button:active::before {
                  left: 100%;
                }
                
                .dpad button:hover {
                  border-color: rgba(0,255,240,0.6);
                  box-shadow: 
                    inset 0 1px 2px rgba(255,255,255,0.1),
                    0 0 20px rgba(0,255,240,0.3),
                    0 4px 8px rgba(0,0,0,0.3);
                }
                .note{ color:#a1a1aa; font-size:12px; text-align:center; margin-top:4px }
                
                /* Mobile note text */
                .mobile-note { display: none; }
                @media (hover: none) and (pointer: coarse) {
                  .note { display: none; }
                  .mobile-note { 
                    display: block; 
                    color:#a1a1aa; 
                    font-size:12px; 
                    text-align:center; 
                    margin-top:8px;
                  }
                }
                .game-controls{ border:1px solid rgba(0,255,240,.2); background:rgba(0,255,240,.03); border-radius:16px; padding:12px; margin-top:24px; overflow:visible; }
                .game-controls h3{ font-size:12px; letter-spacing:.2em; text-transform:uppercase; color:#00fff0; margin:0 0 10px; font-family:var(--title-font) }
                .aside{ position:sticky; top:16px; align-self:start; border:1px solid rgba(255,255,255,.1); background:rgba(12,12,12,.85); border-radius:16px; padding:16px; backdrop-filter:blur(8px); overflow:visible; }
                @media (max-width: 767px){ .aside{ position:static; margin-top:16px; } }
                .aside h3{ font-size:12px; letter-spacing:.2em; text-transform:uppercase; color:#e5e7eb; margin:0 0 8px; font-family:var(--title-font) }

                .volume-slider{ 
                  width:100%; 
                  accent-color:#00fff0; 
                  height:6px; 
                  border-radius:3px; 
                  background:rgba(255,255,255,0.1); 
                  outline:none; 
                  cursor:pointer;
                }
                .volume-slider::-webkit-slider-thumb{ 
                  appearance:none; 
                  width:16px; 
                  height:16px; 
                  border-radius:50%; 
                  background:linear-gradient(135deg, #00fff0, #b400ff); 
                  cursor:pointer; 
                  border:2px solid rgba(255,255,255,0.3);
                  box-shadow:0 0 8px rgba(0,255,240,0.5);
                }
                .volume-slider::-moz-range-thumb{ 
                  width:16px; 
                  height:16px; 
                  border-radius:50%; 
                  background:linear-gradient(135deg, #00fff0, #b400ff); 
                  cursor:pointer; 
                  border:2px solid rgba(255,255,255,0.3);
                  box-shadow:0 0 8px rgba(0,255,240,0.5);
                }
                .volume-slider:disabled{ 
                  opacity:0.4; 
                  cursor:not-allowed;
                }
                .volume-slider:disabled::-webkit-slider-thumb{ 
                  background:#666; 
                  box-shadow:none;
                  cursor:not-allowed;
                }
                .volume-slider:disabled::-moz-range-thumb{ 
                  background:#666; 
                  box-shadow:none;
                  cursor:not-allowed;
                }

                /* Inline Volume Slider - Cyberpunk Styling */
                .inline-volume-slider {
                  -webkit-appearance: none;
                  appearance: none;
                  background: linear-gradient(to right, 
                    rgba(244, 114, 182, 0.6) 0%, 
                    rgba(244, 114, 182, 0.4) 50%, 
                    rgba(244, 114, 182, 0.2) 100%);
                  border-radius: 6px;
                  outline: none;
                  cursor: pointer;
                  border: 1px solid rgba(244, 114, 182, 0.3);
                  box-shadow: 
                    0 0 8px rgba(244, 114, 182, 0.3),
                    inset 0 1px 3px rgba(0, 0, 0, 0.3);
                  transition: all 300ms ease;
                }

                .inline-volume-slider:hover {
                  box-shadow: 
                    0 0 12px rgba(244, 114, 182, 0.5),
                    inset 0 1px 3px rgba(0, 0, 0, 0.3);
                  border-color: rgba(244, 114, 182, 0.5);
                }

                .inline-volume-slider::-webkit-slider-thumb {
                  -webkit-appearance: none;
                  appearance: none;
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                  background: linear-gradient(135deg, #f472b6, #ec4899);
                  border: 2px solid rgba(255, 255, 255, 0.4);
                  cursor: pointer;
                  box-shadow: 
                    0 0 8px rgba(244, 114, 182, 0.6),
                    0 2px 4px rgba(0, 0, 0, 0.3);
                  transition: all 200ms ease;
                }

                .inline-volume-slider::-webkit-slider-thumb:hover {
                  transform: scale(1.1);
                  box-shadow: 
                    0 0 12px rgba(244, 114, 182, 0.8),
                    0 3px 6px rgba(0, 0, 0, 0.4);
                  background: linear-gradient(135deg, #f59e0b, #f472b6);
                }

                .inline-volume-slider::-moz-range-thumb {
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                  background: linear-gradient(135deg, #f472b6, #ec4899);
                  border: 2px solid rgba(255, 255, 255, 0.4);
                  cursor: pointer;
                  box-shadow: 
                    0 0 8px rgba(244, 114, 182, 0.6),
                    0 2px 4px rgba(0, 0, 0, 0.3);
                  transition: all 200ms ease;
                }

                .inline-volume-slider::-moz-range-thumb:hover {
                  transform: scale(1.1);
                  box-shadow: 
                    0 0 12px rgba(244, 114, 182, 0.8),
                    0 3px 6px rgba(0, 0, 0, 0.4);
                  background: linear-gradient(135deg, #f59e0b, #f472b6);
                }
                
                /* Music Control Expansion Styles */
                .music-control-container {
                  position: relative;
                  flex-shrink: 0;
                }
                
                .music-toggle-btn {
                  background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(20,20,30,0.9) 100%);
                  border: 1px solid rgba(244,114,182,0.3);
                  color: #f472b6;
                  fontSize: 16px;
                  cursor: pointer;
                  padding: 10px;
                  border-radius: 10px;
                  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                  position: relative;
                  z-index: 1001;
                  touch-action: manipulation;
                  user-select: none;
                  min-width: 42px;
                  min-height: 42px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  overflow: hidden;
                }
                
                .music-toggle-btn:before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: -100%;
                  width: 100%;
                  height: 100%;
                  background: linear-gradient(90deg, transparent, rgba(244,114,182,0.2), transparent);
                  transition: left 0.6s;
                }
                
                .music-toggle-btn:hover {
                  border-color: rgba(244,114,182,0.6);
                  box-shadow: 
                    0 0 10px rgba(244,114,182,0.3),
                    inset 0 0 10px rgba(244,114,182,0.1);
                  transform: translateY(-1px);
                }
                
                .music-toggle-btn:hover:before {
                  left: 100%;
                }
                
                .music-toggle-btn.expanded {
                  border-color: rgba(244,114,182,0.8);
                  box-shadow: 
                    0 0 15px rgba(244,114,182,0.4),
                    inset 0 0 15px rgba(244,114,182,0.2);
                }

                .music-toggle-btn:active {
                  transform: translateY(0);
                  box-shadow: 
                    0 0 20px rgba(244,114,182,0.5),
                    inset 0 0 20px rgba(244,114,182,0.3);
                }

                @media (max-width: 767px) {
                  .music-volume-panel {
                    min-width: 180px;
                    right: -20px;
                  }
                  
                  .music-toggle-btn {
                    min-width: 44px;
                    min-height: 44px;
                    padding: 10px 14px;
                  }
                }
                
                .music-volume-panel {
                  position: absolute;
                  bottom: 100%;
                  right: 0;
                  background: rgba(10, 10, 10, 0.95);
                  border: 1px solid rgba(0, 255, 240, 0.3);
                  border-radius: 12px;
                  padding: 12px;
                  min-width: 160px;
                  backdrop-filter: blur(8px);
                  box-shadow: 0 4px 20px rgba(0, 255, 240, 0.2);
                  transform-origin: bottom right;
                  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                  z-index: 1000;
                  margin-bottom: 8px;
                }
                
                .music-volume-panel.collapsed {
                  opacity: 0;
                  transform: translateY(10px) scale(0.95);
                  pointer-events: none;
                }
                
                .music-volume-panel.expanded {
                  opacity: 1;
                  transform: translateY(0) scale(1);
                  pointer-events: all;
                }
                
                .music-volume-content {
                  display: flex;
                  flex-direction: column;
                  gap: 8px;
                }
                
                .music-volume-header {
                  font-size: 10px;
                  color: #00fff0;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  font-family: var(--title-font);
                  text-align: center;
                  margin-bottom: 4px;
                }
                
                .music-volume-control {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
                
                .music-volume-panel .volume-slider {
                  flex: 1;
                  min-width: 80px;
                }
                
                .music-volume-value {
                  font-size: 10px;
                  color: #a1a1aa;
                  min-width: 32px;
                  text-align: right;
                  font-family: var(--ui-font);
                }
                /* Show D-pad only on touch devices */
                @media (hover: none) and (pointer: coarse) {
                  .dpad { display: grid !important; }
                }
                
                /* Ensure mobile elements are properly displayed */
                @media (max-width: 768px) {
                  .dpad { display: grid !important; }
                  .mobile-reboot-button { display: block !important; }
                  .keyboard-hints { display: none !important; }
                }
                
                /* Hide mobile reboot button on desktop */
                @media (min-width: 769px) and (hover: hover) and (pointer: fine) {
                  .mobile-reboot-button { display: none !important; }
                }
                
                /* Mobile Reboot Button - Enhanced Cyberpunk Design */
                .mobile-reboot-button {
                  position: absolute;
                  top: 70%; /* 垂直位置调整 */
                  left: 50%; /* 水平居中 */
                  transform: translate(-50%, -50%); /* 完全居中 */
                  padding: 16px 32px; /* 增大按钮 */
                  background: linear-gradient(135deg, #ff00b8 0%, #b400ff 25%, #00fff0 50%, #ff00b8 75%, #b400ff 100%);
                  background-size: 300% 100%;
                  border: 2px solid rgba(0, 255, 240, 0.6);
                  border-radius: 20px;
                  color: #000;
                  font-weight: 900;
                  font-size: 16px;
                  min-height: 56px;
                  min-width: 140px;
                  box-shadow: 
                    0 0 20px rgba(255, 0, 184, 0.4),
                    0 4px 15px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
                  cursor: pointer;
                  touch-action: manipulation;
                  z-index: 1000;
                  font-family: var(--title-font);
                  text-transform: uppercase;
                  letter-spacing: 0.15em;
                  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
                  transition: all 0.3s ease;
                  animation: cyberpunkReboot 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
                  backdrop-filter: blur(4px);
                  z-index: 1000; /* 确保在canvas上方 */
                }

                /* Enhanced Cyberpunk Reboot Animation */
                @keyframes cyberpunkReboot {
                  0% {
                    opacity: 1;
                    box-shadow: 
                      0 0 25px rgba(0, 255, 240, 0.6),
                      0 0 50px rgba(255, 0, 184, 0.3),
                      inset 0 0 20px rgba(0, 255, 240, 0.1);
                    text-shadow: 0 0 8px rgba(0, 255, 240, 0.8);
                    transform: translate(-50%, -50%) scale(1);
                  }
                  15% {
                    opacity: 0.85;
                    box-shadow: 
                      0 0 30px rgba(255, 0, 184, 0.7),
                      0 0 60px rgba(0, 255, 240, 0.4),
                      inset 0 0 25px rgba(255, 0, 184, 0.15);
                    text-shadow: 
                      0 0 10px rgba(255, 0, 184, 0.9),
                      1px 0 2px rgba(0, 255, 240, 0.5);
                    transform: translate(-50%, -50%) scale(1.02);
                  }
                  30% {
                    opacity: 0.75;
                    box-shadow: 
                      0 0 15px rgba(0, 255, 240, 0.8),
                      0 0 35px rgba(255, 0, 184, 0.5);
                    text-shadow: 
                      0 0 6px rgba(0, 255, 240, 1),
                      0.5px 0 1px rgba(255, 0, 184, 0.6);
                    transform: translate(-50%, -50%) scale(0.98);
                  }
                  45% {
                    opacity: 0.9;
                    box-shadow: 
                      0 0 35px rgba(255, 0, 184, 0.8),
                      0 0 70px rgba(0, 255, 240, 0.3),
                      inset 0 0 30px rgba(255, 0, 184, 0.2);
                    text-shadow: 
                      0 0 12px rgba(255, 0, 184, 1),
                      -1px 0 2px rgba(0, 255, 240, 0.7);
                    transform: translate(-50%, -50%) scale(1.01);
                  }
                  60% {
                    opacity: 0.8;
                    box-shadow: 
                      0 0 20px rgba(0, 255, 240, 0.9),
                      0 0 45px rgba(255, 0, 184, 0.4);
                    text-shadow: 
                      0 0 8px rgba(0, 255, 240, 0.9),
                      0.8px 0 1.5px rgba(255, 0, 184, 0.5);
                    transform: translate(-50%, -50%) scale(0.99);
                  }
                  75% {
                    opacity: 0.95;
                    box-shadow: 
                      0 0 40px rgba(255, 0, 184, 0.6),
                      0 0 80px rgba(0, 255, 240, 0.2),
                      inset 0 0 35px rgba(255, 0, 184, 0.1);
                    text-shadow: 
                      0 0 14px rgba(255, 0, 184, 0.8),
                      0 0 6px rgba(0, 255, 240, 1);
                    transform: translate(-50%, -50%) scale(1.03);
                  }
                  90% {
                    opacity: 0.85;
                    box-shadow: 
                      0 0 25px rgba(0, 255, 240, 0.7),
                      0 0 50px rgba(255, 0, 184, 0.3);
                    text-shadow: 
                      0 0 9px rgba(0, 255, 240, 0.9),
                      1px 0 2px rgba(255, 0, 184, 0.6);
                    transform: translate(-50%, -50%) scale(1);
                  }
                  100% {
                    opacity: 1;
                    box-shadow: 
                      0 0 25px rgba(0, 255, 240, 0.6),
                      0 0 50px rgba(255, 0, 184, 0.3),
                      inset 0 0 20px rgba(0, 255, 240, 0.1);
                    text-shadow: 0 0 8px rgba(0, 255, 240, 0.8);
                    transform: translate(-50%, -50%) scale(1);
                  }
                }
                .mobile-reboot-button:active {
                  transform: translate(-50%, -50%) scale(0.92);
                  box-shadow: 
                    0 0 30px rgba(255, 0, 184, 0.7),
                    0 2px 8px rgba(0, 0, 0, 0.4),
                    inset 0 2px 4px rgba(0, 0, 0, 0.2);
                  background-position: 100% 0;
                }
                .mobile-reboot-button:hover {
                  background-position: 100% 0;
                  border-color: rgba(0, 255, 240, 0.8);
                  text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
                }

                @keyframes neonPulse {
                  from {
                    box-shadow: 
                      0 0 20px rgba(255, 0, 184, 0.4),
                      0 4px 15px rgba(0, 0, 0, 0.3),
                      inset 0 1px 0 rgba(255, 255, 255, 0.2);
                  }
                  to {
                    box-shadow: 
                      0 0 30px rgba(255, 0, 184, 0.6),
                      0 0 40px rgba(0, 255, 240, 0.3),
                      0 4px 15px rgba(0, 0, 0, 0.3),
                      inset 0 1px 0 rgba(255, 255, 255, 0.3);
                  }
                }
                
                /* App-style Mobile Menu Trigger */
                .mobile-menu-trigger {
                  position: fixed;
                  top: 20px;
                  right: 20px;
                  width: 50px;
                  height: 50px;
                  background: 
                    radial-gradient(circle at center, rgba(0,255,240,0.15) 0%, rgba(0,0,0,0.9) 100%);
                  border: 2px solid #00fff0;
                  border-radius: 12px;
                  color: #00fff0;
                  font-size: 20px;
                  font-family: var(--title-font);
                  font-weight: 900;
                  cursor: pointer;
                  z-index: 1001;
                  display: none;
                  align-items: center;
                  justify-content: center;
                  backdrop-filter: blur(10px);
                  text-shadow: 0 0 8px rgba(0,255,240,0.6);
                  box-shadow: 
                    0 0 15px rgba(0,255,240,0.3),
                    inset 0 1px 2px rgba(255,255,255,0.1);
                  transition: all 0.3s ease;
                }
                
                .mobile-menu-trigger:active {
                  transform: scale(0.9);
                  color: #ff00b8;
                  border-color: #ff00b8;
                  text-shadow: 0 0 8px rgba(255,0,184,0.6);
                }
                
                /* App-style Floating Menu Panel */
                .mobile-floating-menu {
                  position: fixed;
                  top: 80px;
                  right: 20px;
                  width: 280px;
                  max-height: calc(100vh - 120px);
                  background: 
                    linear-gradient(135deg, rgba(5,10,15,0.98) 0%, rgba(0,5,10,0.99) 100%);
                  backdrop-filter: blur(25px);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 12px;
                  box-shadow: 
                    0 20px 40px rgba(0,0,0,0.8),
                    0 0 30px rgba(0,255,240,0.1),
                    inset 0 1px 1px rgba(0,255,240,0.1);
                  padding: 20px;
                  z-index: 1000;
                  display: none;
                  flex-direction: column;
                  gap: 16px;
                  overflow-y: auto;
                  transform: translateX(300px) translateY(-20px);
                  opacity: 0;
                  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                }
                
                .mobile-floating-menu.show {
                  display: flex;
                  transform: translateX(0) translateY(0);
                  opacity: 1;
                }
                
                .mobile-floating-menu::before {
                  content: '';
                  position: absolute;
                  top: -1px;
                  left: -1px;
                  right: -1px;
                  bottom: -1px;
                  background: linear-gradient(45deg, rgba(0,255,240,0.4), rgba(0,255,240,0.1), rgba(0,255,240,0.4));
                  background-size: 200% 200%;
                  border-radius: 12px;
                  z-index: -1;
                  animation: cyberpunkMenuBorder 6s linear infinite;
                }
                /* 移动端检测：多种条件确保兼容性 */
                @media (hover: none) and (pointer: coarse), 
                       (max-width: 768px), 
                       (orientation: portrait) and (max-width: 1024px) {
                  /* Show bottom nav on mobile */
                  .mobile-bottom-nav { display: flex !important; }
                  
                  /* Hide desktop sidebar on mobile */
                  .aside {
                    display: none;
                  }
                  
                  /* Adjust mobile layout */
                  .container {
                    padding-top: 20px; /* 大幅减少顶部空白 */
                    padding-bottom: 120px; /* 增加底部空间，确保D-pad不被遮挡 */
                  }
                  
                  .dpad {
                    margin: 8px auto 4px auto; /* 减少D-pad上下间距 */
                    padding: 12px;
                    position: relative; /* 为悬浮元素提供定位参考 */
                  }
                  
                  .info-section {
                    display: none; /* 移动端隐藏tip提示 */
                  }

                  /* 移动端隐藏Game Controls */
                  .game-controls {
                    display: none;
                  }

                  /* 禁止页面滚动 */
                  body {
                    overflow: hidden;
                    height: 100vh;
                    position: fixed;
                    width: 100%;
                  }

                  .wrap {
                    overflow: hidden;
                    height: 100vh;
                  }

                  /* 移动端悬浮Score面板 */
                  .floating-score-left,
                  .floating-score-right {
                    position: absolute;
                    top: 50%;
                    transform: translateY(-50%);
                    z-index: 100;
                    pointer-events: none; /* 不影响D-pad操作 */
                    display: block; /* 在移动端显示 */
                  }

                  .floating-score-left {
                    left: -85px; /* Score放在D-pad左侧 */
                  }

                  .floating-score-right {
                    right: -85px; /* Best放在D-pad右侧 */
                  }

                  .floating-score-left .panel,
                  .floating-score-right .panel {
                    pointer-events: auto;
                    min-width: 65px; /* 紧凑的面板宽度 */
                    padding: 8px 10px; /* 调整内边距 */
                  }

                  .floating-score-left .panel h5,
                  .floating-score-right .panel h5 {
                    font-size: 10px; /* 稍小的标题字体 */
                    margin-bottom: 4px;
                  }

                  .floating-score-left .panel .val,
                  .floating-score-right .panel .val {
                    font-size: 16px; /* 保持数值清晰可读 */
                  }
                }
                
                /* 5 Button Menu Layout */
                .mobile-menu-buttons {
                  display: grid;
                  grid-template-columns: repeat(2, 1fr);
                  grid-template-rows: repeat(3, 1fr);
                  gap: 12px;
                  margin-bottom: 16px;
                }
                
                .mobile-menu-buttons button:last-child {
                  grid-column: 1 / -1;
                }
                
                .menu-action-btn {
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.8) 0%, rgba(0,15,20,0.9) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 8px;
                  color: rgba(0,255,240,0.9);
                  padding: 16px 12px;
                  min-height: 70px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  gap: 6px;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  backdrop-filter: blur(5px);
                  font-family: var(--title-font);
                }
                
                .menu-action-btn:active {
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.15) 0%, rgba(0,200,200,0.1) 100%);
                  border-color: rgba(0,255,240,0.6);
                  transform: scale(0.96);
                  box-shadow: inset 0 2px 4px rgba(0,255,240,0.1);
                }
                
                .btn-icon {
                  font-size: 14px;
                  font-weight: 700;
                  opacity: 0.9;
                  font-family: var(--title-font);
                  letter-spacing: 0.1em;
                  text-shadow: 0 0 6px rgba(0,255,240,0.4);
                }
                
                .btn-label {
                  font-size: 10px;
                  font-weight: 600;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  opacity: 0.8;
                }
                
                .mobile-menu-section h4 {
                  color: #00fff0;
                  font-family: var(--title-font);
                  font-size: 13px;
                  font-weight: 700;
                  margin: 0 0 12px 0;
                  text-transform: uppercase;
                  letter-spacing: 0.15em;
                  text-shadow: 0 0 8px rgba(0,255,240,0.3);
                  opacity: 0.9;
                }
                
                .mobile-menu-grid {
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                }
                
                .mobile-menu-grid button, .mobile-menu-grid select {
                  min-height: 44px;
                  font-size: 11px;
                  font-family: var(--title-font);
                  font-weight: 600;
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.8) 0%, rgba(0,10,15,0.9) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  color: rgba(0,255,240,0.9);
                  border-radius: 6px;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                  transition: all 0.2s ease;
                  backdrop-filter: blur(5px);
                }
                
                .mobile-menu-grid button:active {
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.1) 0%, rgba(0,200,200,0.05) 100%);
                  border-color: rgba(0,255,240,0.6);
                  color: #00fff0;
                  transform: scale(0.96);
                  box-shadow: inset 0 2px 4px rgba(0,255,240,0.1);
                }
                
                .mobile-menu-tab {
                  flex: 1;
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.05) 0%, transparent 50%, rgba(0,255,240,0.05) 100%);
                  border: 1px solid rgba(0, 255, 240, 0.4);
                  color: #00fff0;
                  padding: 10px 6px;
                  font-size: 10px;
                  font-family: var(--title-font);
                  font-weight: 700;
                  cursor: pointer;
                  text-align: center;
                  min-height: 48px;
                  touch-action: manipulation;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  gap: 3px;
                  position: relative;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                  clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
                  text-shadow: 
                    0 0 5px rgba(0,255,240,0.5),
                    0 0 10px rgba(0,255,240,0.3);
                  transition: all 0.2s ease;
                }
                
                .mobile-menu-tab::before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: linear-gradient(45deg, transparent 0%, rgba(0,255,240,0.1) 50%, transparent 100%);
                  opacity: 0;
                  transition: opacity 0.2s ease;
                  clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
                }
                
                .mobile-menu-tab.active {
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.15) 0%, rgba(255,0,184,0.1) 50%, rgba(0,255,240,0.15) 100%);
                  border-color: #00fff0;
                  color: #ffffff;
                  text-shadow: 
                    0 0 8px #00fff0,
                    0 0 15px rgba(0,255,240,0.6);
                  box-shadow: 
                    inset 0 0 15px rgba(0,255,240,0.2),
                    0 0 15px rgba(0,255,240,0.3);
                }
                
                .mobile-menu-tab.active::before {
                  opacity: 1;
                }
                
                .mobile-menu-tab:active {
                  transform: scale(0.92);
                  color: #ff00b8;
                  text-shadow: 
                    0 0 8px #ff00b8,
                    0 0 15px rgba(255,0,184,0.6);
                }
                
                .mobile-menu-content {
                  margin-top: 12px;
                  background: rgba(0, 255, 240, 0.05);
                  border: 1px solid rgba(0, 255, 240, 0.2);
                  border-radius: 12px;
                  padding: 12px;
                  max-height: 200px;
                  overflow-y: auto;
                }
                
                .mobile-controls-grid {
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                }
                .mobile-controls-grid button, .mobile-controls-grid select {
                  min-height: 44px;
                  font-size: 14px;
                }

                /* Quick Controls Styling */
                .quick-controls {
                  background: 
                    linear-gradient(135deg, rgba(0,15,20,0.6) 0%, rgba(0,10,15,0.8) 100%);
                  border: 1px solid rgba(0,255,240,0.2);
                  border-radius: 8px;
                  padding: 12px;
                  margin-top: 12px;
                  backdrop-filter: blur(5px);
                }

                .control-row {
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 10px;
                  gap: 12px;
                }

                .control-row:last-child {
                  margin-bottom: 0;
                }

                .control-row > span:first-child {
                  color: rgba(0,255,240,0.8);
                  font-size: 11px;
                  font-weight: 600;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                  font-family: var(--title-font);
                  min-width: 70px;
                }

                .inline-select {
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.9) 0%, rgba(0,15,20,0.95) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 4px;
                  color: rgba(0,255,240,0.9);
                  padding: 6px 8px;
                  font-size: 10px;
                  font-family: var(--title-font);
                  font-weight: 600;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                  min-width: 80px;
                  backdrop-filter: blur(3px);
                  cursor: pointer;
                }

                .inline-slider {
                  flex: 1;
                  height: 20px;
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.8) 0%, rgba(0,15,20,0.9) 100%);
                  border-radius: 10px;
                  outline: none;
                  border: 1px solid rgba(0,255,240,0.3);
                  cursor: pointer;
                  margin: 0 8px;
                }

                .inline-slider::-webkit-slider-thumb {
                  appearance: none;
                  width: 16px;
                  height: 16px;
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.9) 0%, rgba(0,200,200,0.8) 100%);
                  border-radius: 50%;
                  border: 1px solid rgba(0,255,240,0.5);
                  cursor: pointer;
                  box-shadow: 0 0 8px rgba(0,255,240,0.4);
                }

                .inline-slider::-moz-range-thumb {
                  width: 16px;
                  height: 16px;
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.9) 0%, rgba(0,200,200,0.8) 100%);
                  border-radius: 50%;
                  border: 1px solid rgba(0,255,240,0.5);
                  cursor: pointer;
                  box-shadow: 0 0 8px rgba(0,255,240,0.4);
                }

                .control-row > span:last-child {
                  color: rgba(0,255,240,0.7);
                  font-size: 10px;
                  font-weight: 600;
                  min-width: 35px;
                  text-align: right;
                  font-family: var(--title-font);
                }

                .stats-quick {
                  display: flex;
                  justify-content: space-between;
                  padding-top: 8px;
                  border-top: 1px solid rgba(0,255,240,0.15);
                  margin-top: 8px;
                }

                .stats-quick span {
                  color: rgba(0,255,240,0.8);
                  font-size: 10px;
                  font-weight: 600;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                  font-family: var(--title-font);
                }

                /* Mobile Bottom Navigation Bar */
                .mobile-bottom-nav {
                  position: fixed;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  display: none; /* 默认隐藏，移动端通过媒体查询显示 */
                  justify-content: space-around;
                  align-items: center;
                  background: 
                    linear-gradient(180deg, rgba(0,10,15,0.95) 0%, rgba(0,5,10,0.98) 100%);
                  backdrop-filter: blur(20px);
                  border-top: 1px solid rgba(0,255,240,0.3);
                  padding: 12px 8px calc(env(safe-area-inset-bottom) + 8px);
                  z-index: 1000;
                  box-shadow: 
                    0 -10px 30px rgba(0,0,0,0.6),
                    0 0 20px rgba(0,255,240,0.1);
                  /* 防止拖拽和滚动 */
                  touch-action: manipulation;
                  user-select: none;
                  -webkit-user-select: none;
                  -webkit-touch-callout: none;
                  overscroll-behavior: none;
                  overflow: hidden;
                }
                
                .mobile-bottom-nav::before {
                  content: '';
                  position: absolute;
                  top: -1px;
                  left: 0;
                  right: 0;
                  height: 1px;
                  background: linear-gradient(90deg, transparent 0%, rgba(0,255,240,0.6) 50%, transparent 100%);
                  animation: cyberpunkNavBorder 4s linear infinite;
                }
                
                @keyframes cyberpunkNavBorder {
                  0%, 100% { opacity: 0.3; }
                  50% { opacity: 0.8; }
                }

                .nav-btn {
                  flex: 1;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  background: transparent;
                  border: none;
                  color: rgba(0,255,240,0.8);
                  cursor: pointer;
                  padding: 8px 4px;
                  max-width: 80px;
                  transition: all 0.2s ease;
                  touch-action: manipulation;
                  user-select: none;
                  -webkit-user-select: none;
                  -webkit-touch-callout: none;
                  -webkit-user-drag: none;
                  gap: 4px;
                  /* 防止按钮被拖拽 */
                  pointer-events: auto;
                  position: relative;
                }

                .nav-btn:active {
                  transform: scale(0.95);
                  color: rgba(0,255,240,1);
                }

                .nav-icon {
                  font-size: 11px;
                  font-weight: 700;
                  font-family: var(--title-font);
                  letter-spacing: 0.1em;
                  text-shadow: 0 0 6px rgba(0,255,240,0.4);
                  margin-bottom: 2px;
                }

                .nav-label {
                  font-size: 9px;
                  font-weight: 500;
                  font-family: var(--title-font);
                  text-transform: capitalize;
                  letter-spacing: 0.05em;
                  opacity: 0.8;
                  line-height: 1;
                }

                /* Mobile Settings Modal */
                .mobile-settings-overlay {
                  position: fixed;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: rgba(0,0,0,0.8);
                  backdrop-filter: blur(10px);
                  z-index: 2000;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  padding: 20px;
                }

                .mobile-settings-modal {
                  background: 
                    linear-gradient(135deg, rgba(0,15,20,0.95) 0%, rgba(0,10,15,0.98) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 12px;
                  backdrop-filter: blur(20px);
                  box-shadow: 
                    0 20px 40px rgba(0,0,0,0.8),
                    0 0 30px rgba(0,255,240,0.1);
                  width: 100%;
                  max-width: 320px;
                  max-height: 80vh;
                  overflow-y: auto;
                }

                .settings-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 20px 20px 20px;
                  border-bottom: 1px solid rgba(0,255,240,0.2);
                  margin-bottom: 20px;
                }

                .settings-header h3 {
                  color: #00fff0;
                  font-family: var(--title-font);
                  font-size: 18px;
                  font-weight: 700;
                  margin: 0;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  text-shadow: 0 0 10px rgba(0,255,240,0.4);
                }

                .close-btn {
                  background: transparent;
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 6px;
                  color: rgba(0,255,240,0.8);
                  font-size: 16px;
                  width: 32px;
                  height: 32px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  transition: all 0.2s ease;
                }

                .close-btn:active {
                  background: rgba(0,255,240,0.1);
                  border-color: rgba(0,255,240,0.6);
                  transform: scale(0.95);
                }

                .settings-content {
                  padding: 0 20px 20px;
                }

                .setting-item {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 16px;
                  gap: 12px;
                }

                .setting-item label {
                  color: rgba(0,255,240,0.8);
                  font-family: var(--title-font);
                  font-size: 12px;
                  font-weight: 600;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                  min-width: 70px;
                }

                .setting-select {
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.9) 0%, rgba(0,15,20,0.95) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 6px;
                  color: rgba(0,255,240,0.9);
                  padding: 8px 12px;
                  font-size: 11px;
                  font-family: var(--title-font);
                  font-weight: 600;
                  min-width: 80px;
                  cursor: pointer;
                }

                .volume-control {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  flex: 1;
                  margin-top: 8px;
                  width: 100%;
                }
                @media (max-width: 767px) {
                  .volume-control {
                    flex-direction: column;
                    align-items: stretch;
                    margin-top: 16px;
                  }
                }

                .setting-slider {
                  flex: 1;
                  height: 20px;
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.8) 0%, rgba(0,15,20,0.9) 100%);
                  border-radius: 10px;
                  outline: none;
                  border: 1px solid rgba(0,255,240,0.3);
                  cursor: pointer;
                }

                .setting-slider::-webkit-slider-thumb {
                  appearance: none;
                  width: 16px;
                  height: 16px;
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.9) 0%, rgba(0,200,200,0.8) 100%);
                  border-radius: 50%;
                  border: 1px solid rgba(0,255,240,0.5);
                  cursor: pointer;
                  box-shadow: 0 0 8px rgba(0,255,240,0.4);
                }

                .volume-text {
                  color: rgba(0,255,240,0.7);
                  font-size: 10px;
                  font-weight: 600;
                  min-width: 35px;
                  text-align: right;
                  font-family: var(--title-font);
                }

                .setting-toggle {
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.8) 0%, rgba(0,15,20,0.9) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 6px;
                  color: rgba(0,255,240,0.9);
                  padding: 8px 16px;
                  font-size: 11px;
                  font-family: var(--title-font);
                  font-weight: 700;
                  min-width: 50px;
                  cursor: pointer;
                  transition: all 0.2s ease;
                }

                .setting-toggle.enabled {
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.2) 0%, rgba(0,200,200,0.1) 100%);
                  border-color: rgba(0,255,240,0.5);
                  color: #00fff0;
                }

                .setting-toggle:active {
                  transform: scale(0.95);
                }

                .stats-section {
                  margin-top: 24px;
                  padding-top: 16px;
                  border-top: 1px solid rgba(0,255,240,0.2);
                }

                .stats-section h4 {
                  color: #00fff0;
                  font-family: var(--title-font);
                  font-size: 14px;
                  font-weight: 700;
                  margin: 0 0 12px 0;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  text-shadow: 0 0 8px rgba(0,255,240,0.3);
                }

                .stats-grid {
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                }

                .stat-item {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  background: rgba(0,255,240,0.05);
                  border: 1px solid rgba(0,255,240,0.1);
                  border-radius: 6px;
                  padding: 8px;
                }

                .stat-label {
                  color: rgba(0,255,240,0.7);
                  font-size: 10px;
                  font-weight: 500;
                  font-family: var(--title-font);
                }

                .stat-value {
                  color: rgba(0,255,240,0.9);
                  font-size: 11px;
                  font-weight: 700;
                  font-family: var(--title-font);
                }

                /* 排行榜特定样式 */
                .submit-score-section {
                  margin-bottom: 20px;
                  padding-bottom: 16px;
                  border-bottom: 1px solid rgba(0,255,240,0.2);
                }

                .setting-input {
                  background: 
                    linear-gradient(135deg, rgba(0,20,25,0.9) 0%, rgba(0,15,20,0.95) 100%);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 6px;
                  color: rgba(0,255,240,0.9);
                  padding: 8px 12px;
                  font-size: 11px;
                  font-family: var(--title-font);
                  font-weight: 600;
                  flex: 1;
                  outline: none;
                }

                .setting-input::placeholder {
                  color: rgba(0,255,240,0.5);
                }

                .submit-btn {
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.2) 0%, rgba(0,200,200,0.1) 100%);
                  border: 1px solid rgba(0,255,240,0.5);
                  border-radius: 6px;
                  color: #00fff0;
                  padding: 10px 20px;
                  font-size: 11px;
                  font-family: var(--title-font);
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  margin-top: 12px;
                  width: 100%;
                }

                .submit-btn.disabled {
                  background: rgba(0,20,25,0.5);
                  border-color: rgba(0,255,240,0.2);
                  color: rgba(0,255,240,0.4);
                  cursor: not-allowed;
                }

                .submit-btn:not(.disabled):active {
                  transform: scale(0.98);
                  background: 
                    linear-gradient(135deg, rgba(0,255,240,0.3) 0%, rgba(0,200,200,0.2) 100%);
                }

                .error-msg {
                  color: #ff4444;
                  font-size: 10px;
                  margin-top: 8px;
                  text-align: center;
                }

                .leaderboard-section h4 {
                  color: #00fff0;
                  font-family: var(--title-font);
                  font-size: 14px;
                  font-weight: 700;
                  margin: 0 0 12px 0;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  text-shadow: 0 0 8px rgba(0,255,240,0.3);
                }

                .scores-list {
                  max-height: 300px;
                  overflow-y: auto;
                }

                .score-entry {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  background: rgba(0,255,240,0.03);
                  border: 1px solid rgba(0,255,240,0.1);
                  border-radius: 6px;
                  padding: 10px;
                  margin-bottom: 6px;
                  transition: all 0.2s ease;
                }

                .score-entry:hover {
                  background: rgba(0,255,240,0.08);
                  border-color: rgba(0,255,240,0.2);
                }

                .rank-info {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }

                .rank {
                  color: rgba(0,255,240,0.8);
                  font-size: 10px;
                  font-weight: 700;
                  font-family: var(--title-font);
                  min-width: 25px;
                }

                .player-name {
                  color: rgba(0,255,240,0.9);
                  font-size: 11px;
                  font-weight: 600;
                  font-family: var(--title-font);
                }

                .player-name.highlight {
                  color: #ff00b8;
                  text-shadow: 0 0 6px rgba(255,0,184,0.4);
                }

                .score-info {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }

                .score-value {
                  color: #00fff0;
                  font-size: 12px;
                  font-weight: 700;
                  font-family: var(--title-font);
                }

                .difficulty-badge {
                  background: rgba(0,255,240,0.1);
                  border: 1px solid rgba(0,255,240,0.3);
                  border-radius: 4px;
                  color: rgba(0,255,240,0.8);
                  font-size: 8px;
                  font-weight: 600;
                  padding: 2px 6px;
                  text-transform: uppercase;
                  letter-spacing: 0.05em;
                }

                .no-scores {
                  text-align: center;
                  color: rgba(0,255,240,0.6);
                  font-size: 11px;
                  font-style: italic;
                  padding: 20px;
                }

                /* 桌面端隐藏悬浮Score面板，显示原始bar */
                @media (min-width: 769px) {
                  .floating-score-left,
                  .floating-score-right {
                    display: none;
                  }
                  .desktop-only {
                    display: flex;
                  }
                  
                  /* 桌面端恢复正常显示 */
                  .info-section {
                    display: block;
                  }
                  
                  .game-controls {
                    display: block;
                  }

                  /* 桌面端恢复页面滚动 */
                  body {
                    overflow: auto;
                    height: auto;
                    position: static;
                    width: auto;
                  }

                  .wrap {
                    overflow: auto;
                    height: auto;
                  }
                }

                /* 移动端隐藏桌面版score bar */
                .desktop-only {
                  display: none;
                }
                
                .main-content{ display:flex; flex-direction:column; gap:16px; }
                .game-section{ flex:1; position: relative; }
                .info-section{ margin-top:8px; }
              `}</style>
            </>
          );

          // Render
          return (
            <div className="wrap">
              {Styles}
              <div className="container">
                <div className="header">
                  <div className="title">
                    <span className="neon-flow" data-text={GAME_TITLE}>{GAME_TITLE}</span>
                  </div>
                  <div className="keyboard-hints" style={{ position: 'relative' }}>
                    <span className="kbd">WASD</span><span style={{ color: '#71717a' }}>/</span>
                    <span className="kbd" style={{ borderColor: 'rgba(255,0,184,.3)', background: 'rgba(255,0,184,.08)', color: '#f5d0fe' }}>Arrows</span>
                    <span style={{ color: '#71717a' }}>•</span>
                    <span className="kbd" style={{ borderColor: 'rgba(0,255,240,.3)', background: 'rgba(0,255,240,.08)', color: '#a7f3f0' }}>Space</span>
                    <span style={{ color: '#a1a1aa' }}>Pause</span>
                    <span style={{ color: '#71717a' }}>•</span>
                    <span className="kbd" style={{ borderColor: 'rgba(180,0,255,.3)', background: 'rgba(180,0,255,.08)', color: '#d8b4fe' }}>R</span>
                    <span style={{ color: '#a1a1aa' }}>Restart</span>
                    <span style={{ color: '#71717a' }}>•</span>
                    <span className="kbd" style={{ borderColor: 'rgba(255,204,0,.3)', background: 'rgba(255,204,0,.08)', color: '#fef3c7', position: 'relative' }}>
                      D
                      {showDifficultyIndicator && (
                        <span style={{
                          position: 'absolute',
                          top: '-24px',
                          left: '50%',
                          transform: 'translateX(-50%)',
                          background: 'linear-gradient(135deg, rgba(255,204,0,0.9) 0%, rgba(255,170,0,0.9) 100%)',
                          color: '#000',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          fontSize: '10px',
                          fontWeight: 'bold',
                          whiteSpace: 'nowrap',
                          boxShadow: '0 2px 8px rgba(255,204,0,0.4)',
                          animation: 'fadeInOut 1.5s ease-in-out',
                          zIndex: 1000
                        }}>
                          {difficulty}
                        </span>
                      )}
                    </span>
                    <span style={{ color: '#a1a1aa' }}>Difficulty</span>
                    <span style={{ color: '#71717a' }}>•</span>
                    <span className="kbd" style={{ 
                      borderColor: 'rgba(244,114,182,.3)', 
                      background: 'rgba(244,114,182,.08)', 
                      color: '#fbcfe8',
                      position: 'relative'
                    }}>
                      M
                      {!musicEnabled && (
                        <span style={{
                          position: 'absolute',
                          top: '50%',
                          left: '0',
                          right: '0',
                          height: '2px',
                          background: 'linear-gradient(90deg, transparent 0%, rgba(244, 114, 182, 0.3) 20%, rgba(244, 114, 182, 0.3) 80%, transparent 100%)',
                          transform: 'translateY(-50%) rotate(-15deg)',
                          pointerEvents: 'none'
                        }}></span>
                      )}
                    </span>
                    <span style={{ 
                      color: '#a1a1aa', 
                      display: 'inline-flex', 
                      alignItems: 'center', 
                      gap: '6px',
                      verticalAlign: 'baseline'
                    }}>
                      Music
                      {musicEnabled && (
                        <input 
                          type="range" 
                          min="0" 
                          max="100" 
                          value={musicVolume * 100} 
                          onChange={handleMusicVolumeChange}
                          className="inline-volume-slider"
                          style={{
                            width: '60px',
                            height: '4px',
                            opacity: musicEnabled ? 1 : 0,
                            transition: 'opacity 300ms ease, transform 300ms ease',
                            transform: musicEnabled ? 'scaleX(1)' : 'scaleX(0.8)',
                            verticalAlign: 'middle'
                          }}
                        />
                      )}
                    </span>
                  </div>
                </div>

                <div className="grid">
                  <div className="main-content">
                    {/* 桌面端Score Bar */}
                    <div className="bar desktop-only">
                      <div className="panel score">
                        <h5>Score</h5>
                        <div className="val">{score}</div>
                      </div>
                      <div className="panel score best">
                        <h5>Best</h5>
                        <div className="val">{best}</div>
                      </div>
                    </div>

                    <div className="game-section">
                      <div className="frame">
                        <div className="frame-inner">
                          <div className="canvas-wrap" style={{ position: 'relative' }}>
                            <canvas ref={canvasRef} width={canvasSize} height={canvasSize} style={{ display: 'block', borderRadius: 16, border: '1px solid rgba(34,211,238,.25)', boxShadow: '0 0 40px rgba(0,255,255,.2)' }} />
                            
                            {/* Mobile Reboot Button - only show on mobile when game is over */}
                            {(isMobile || window.innerWidth <= 768) && isGameOver && (
                              <button 
                                className="mobile-reboot-button"
                                onClick={handleMobileRebootClick}
                                onTouchStart={handleMobileRebootTouchStart}
                              >
                                REBOOT
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="dpad">
                      {/* 悬浮Score面板 - 左侧 */}
                      <div className="floating-score-left">
                        <div className="panel score">
                          <h5>Score</h5>
                          <div className="val">{score}</div>
                        </div>
                      </div>
                      
                      {/* 悬浮Best面板 - 右侧 */}
                      <div className="floating-score-right">
                        <div className="panel score best">
                          <h5>Best</h5>
                          <div className="val">{best}</div>
                        </div>
                      </div>

                      <div />
                      <button 
                        onTouchStart={handleUpTouch}
                        onClick={handleUpClick}
                      >▲</button>
                      <div />
                      <button 
                        onTouchStart={handleLeftTouch}
                        onClick={handleLeftClick}
                      >◀</button>
                      <button 
                        onTouchStart={handlePauseTouch}
                        onClick={handlePauseClick}
                        style={{ 
                          background: running ? 'rgba(255,0,184,0.1)' : 'rgba(0,255,0,0.1)',
                          fontSize: '10px',
                          fontWeight: '700',
                          fontFamily: 'var(--title-font)',
                          letterSpacing: '0.1em'
                        }}
                      >{running ? 'PAUSE' : 'PLAY'}</button>
                      <button 
                        onTouchStart={handleRightTouch}
                        onClick={handleRightClick}
                      >▶</button>
                      <div />
                      <button 
                        onTouchStart={handleDownTouch}
                        onClick={handleDownClick}
                      >▼</button>
                      <div />
                    </div>

                  </div>

                  <aside className="aside">
                    <h3>Leaderboard</h3>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <input 
                        value={name} 
                        onChange={handleNameInputChange} 
                        maxLength={16} 
                        placeholder="Enter your name..." 
                      />
                      <button 
                        disabled={!isGameOver || submitting || score === 0 || score < best} 
                        onClick={submitScore}
                        className={isGameOver && score > 0 && score >= best && !submitting ? 'submit-pulse' : ''}
                        style={{ 
                          background: (!isGameOver || submitting || score === 0 || score < best) ? '#0a0a0a' : '#1a0a2a',
                          borderColor: (!isGameOver || submitting || score === 0 || score < best) ? '#3f3f46' : '#00fff0',
                          opacity: (!isGameOver || submitting || score === 0 || score < best) ? 0.5 : 1,
                          transition: 'all 0.3s ease'
                        }}
                        title={score < best ? `Submit only available for scores ≥ ${best}` : 'Submit your score'}
                      >
                        {submitting ? 'Submitting...' : 'Submit'}
                      </button>
                    </div>
                    {errorMsg && <div style={{ color: errorMsg.includes('successfully') ? '#10b981' : '#f87171', marginTop: 6, fontSize: 12 }}>{errorMsg}</div>}
                    
                    <div style={{ marginTop: 12 }}>
                      {topScores.length > 0 ? (
                        <div>
                          <div style={{ fontSize: 11, color: '#a1a1aa', marginBottom: 8 }}>🏆 Top Scores</div>
                          <div style={{ maxHeight: '120px', overflowY: 'auto' }}>
                            {topScores.slice(0, 5).map((entry, index) => (
                              <div key={`${entry.name}-${entry.timestamp}`} style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                padding: '4px 8px', 
                                marginBottom: '2px',
                                background: entry.name === name ? 'rgba(0,255,240,0.1)' : 'rgba(255,255,255,0.02)',
                                borderRadius: '6px',
                                fontSize: '11px'
                              }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                                  <span style={{ color: index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#a1a1aa', minWidth: '16px' }}>
                                    #{index + 1}
                                  </span>
                                  <span style={{ color: entry.name === name ? '#00fff0' : '#e4e4e7' }}>{entry.name}</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                                  <span style={{ color: '#00fff0', fontWeight: 'bold' }}>{entry.score}</span>
                                  <span style={{ color: '#a1a1aa', fontSize: '9px' }}>{entry.difficulty}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : (
                        <div style={{ fontSize: 11, color: '#a1a1aa' }}>No scores yet. Be the first to set a record!</div>
                      )}
                      
                      <div style={{ border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', padding: '12px', background: 'rgba(255,255,255,0.02)', marginTop: '12px' }}>
                        <h4 style={{ fontSize: '11px', letterSpacing: '.2em', textTransform: 'uppercase', color: '#a1a1aa', margin: '0 0 8px', fontFamily: 'var(--title-font)' }}>Your Stats</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', fontSize: '12px' }}>
                          <div>
                            <div style={{ color: '#71717a', fontSize: '10px' }}>Current Score</div>
                            <div style={{ color: '#00fff0', fontWeight: 'bold' }}>{score}</div>
                          </div>
                          <div>
                            <div style={{ color: '#71717a', fontSize: '10px' }}>Personal Best</div>
                            <div style={{ color: '#f472b6', fontWeight: 'bold' }}>{best}</div>
                          </div>
                          <div>
                            <div style={{ color: '#71717a', fontSize: '10px' }}>Games Played</div>
                            <div style={{ color: '#a78bfa' }}>{playerStats.gamesPlayed}</div>
                          </div>
                          <div>
                            <div style={{ color: '#71717a', fontSize: '10px' }}>Avg Score</div>
                            <div style={{ color: '#10b981' }}>{playerStats.avgScore}</div>
                          </div>
                        </div>
                        <div style={{ marginTop: '8px', paddingTop: '8px', borderTop: '1px solid rgba(255,255,255,0.1)' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ color: '#71717a', fontSize: '10px' }}>Status</div>
                            <div style={{ color: isAlive ? '#10b981' : '#ef4444', fontSize: '11px' }}>
                              {isAlive ? 'Playing' : 'Game Over'}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    </div>

                  </aside>
                </div>

                {/* Bottom Navigation Bar for Mobile */}
                {/* Always render, but only show on mobile via CSS media query */}
                  <div className="mobile-bottom-nav">
                    {/* Pause/Resume Button */}
                    <button 
                      className="nav-btn"
                      onClick={() => {
                        hapticFeedback('medium');
                        setRunning(r => { if (r) sfx.pause(); else sfx.resume(); return !r; });
                      }}
                    >
                      <div className="nav-icon">{running ? 'PAUSE' : 'PLAY'}</div>
                      <div className="nav-label">{running ? 'Game' : 'Resume'}</div>
                    </button>

                    {/* Restart Button */}
                    <button 
                      className="nav-btn"
                      onClick={() => {
                        hapticFeedback('heavy');
                        onRestart();
                      }}
                    >
                      <div className="nav-icon">RESTART</div>
                      <div className="nav-label">Game</div>
                    </button>

                    {/* Audio Button */}
                    <button 
                      className="nav-btn"
                      onClick={() => setMusicEnabled(m => !m)}
                    >
                      <div className="nav-icon">{musicEnabled ? 'MUSIC' : 'MUTE'}</div>
                      <div className="nav-label">Audio</div>
                    </button>

                    {/* Leaderboard Button */}
                    <button 
                      className="nav-btn"
                      onClick={() => {
                        hapticFeedback('light');
                        setShowMobileLeaderboard(!showMobileLeaderboard);
                      }}
                    >
                      <div className="nav-icon">HIGH</div>
                      <div className="nav-label">Scores</div>
                    </button>

                    {/* Settings Button */}
                    <button 
                      className="nav-btn"
                      onClick={() => {
                        hapticFeedback('light');
                        setShowMobileSettings(!showMobileSettings);
                      }}
                    >
                      <div className="nav-icon">CONFIG</div>
                      <div className="nav-label">Settings</div>
                    </button>
                  </div>

                {/* Mobile Settings Modal */}
                {showMobileSettings && (
                  <div className="mobile-settings-overlay">
                    <div className="mobile-settings-modal">
                      <div className="settings-header">
                        <h3>Settings</h3>
                        <button 
                          className="close-btn"
                          onClick={() => setShowMobileSettings(false)}
                        >
                          ✕
                        </button>
                      </div>
                      
                      <div className="settings-content">
                        <div className="setting-item">
                          <label>Difficulty:</label>
                          <select 
                            value={difficulty} 
                            onChange={e => setDifficulty(e.target.value)}
                            className="setting-select"
                          >
                            <option>Chill</option>
                            <option>Swift</option>
                            <option>Hyper</option>
                          </select>
                        </div>
                        
                        <div className="setting-item">
                          <label>Volume:</label>
                          <div className="volume-control">
                            <input 
                              type="range" 
                              min="0" 
                              max="100" 
                              value={musicVolume * 100} 
                              onChange={handleMusicVolumeChange}
                              className="setting-slider"
                              disabled={!musicEnabled}
                            />
                            <span className="volume-text">{Math.round(musicVolume * 100)}%</span>
                          </div>
                        </div>

                        <div className="setting-item">
                          <label>Music:</label>
                          <button 
                            className={`setting-toggle ${musicEnabled ? 'enabled' : 'disabled'}`}
                            onClick={() => setMusicEnabled(!musicEnabled)}
                          >
                            {musicEnabled ? 'ON' : 'OFF'}
                          </button>
                        </div>

                        <div className="stats-section">
                          <h4>Stats</h4>
                          <div className="stats-grid">
                            <div className="stat-item">
                              <span className="stat-label">Score:</span>
                              <span className="stat-value">{score}</span>
                            </div>
                            <div className="stat-item">
                              <span className="stat-label">Best:</span>
                              <span className="stat-value">{best}</span>
                            </div>
                            <div className="stat-item">
                              <span className="stat-label">Games:</span>
                              <span className="stat-value">{playerStats.gamesPlayed}</span>
                            </div>
                            <div className="stat-item">
                              <span className="stat-label">Avg:</span>
                              <span className="stat-value">{playerStats.avgScore}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Mobile Leaderboard Modal */}
                {showMobileLeaderboard && (
                  <div className="mobile-settings-overlay">
                    <div className="mobile-settings-modal">
                      <div className="settings-header">
                        <h3>Leaderboard</h3>
                        <button 
                          className="close-btn"
                          onClick={() => setShowMobileLeaderboard(false)}
                        >
                          ✕
                        </button>
                      </div>
                      
                      <div className="settings-content">
                        {/* 提交分数区域 */}
                        {isGameOver && score > 0 && (
                          <div className="submit-score-section">
                            <div className="setting-item">
                              <label>Name:</label>
                              <input 
                                value={name} 
                                onChange={handleNameInputChange} 
                                maxLength={16} 
                                placeholder="Enter your name..."
                                className="setting-input"
                              />
                            </div>
                            <button 
                              disabled={submitting || score === 0 || score < best} 
                              onClick={submitScore}
                              className={`submit-btn ${submitting || score === 0 || score < best ? 'disabled' : (score >= best ? 'submit-pulse enabled' : 'enabled')}`}
                              title={score < best ? `Submit only available for scores ≥ ${best}` : 'Submit your score'}
                            >
                              {submitting ? 'Submitting...' : 'Submit Score'}
                            </button>
                            {errorMsg && <div className="error-msg">{errorMsg}</div>}
                          </div>
                        )}

                        {/* 排行榜列表 */}
                        <div className="leaderboard-section">
                          <h4>Top Scores</h4>
                          {topScores.length > 0 ? (
                            <div className="scores-list">
                              {topScores.slice(0, 10).map((entry, i) => (
                                <div key={i} className="score-entry">
                                  <div className="rank-info">
                                    <span className="rank">#{i + 1}</span>
                                    <span className={`player-name ${entry.name === name ? 'highlight' : ''}`}>
                                      {entry.name}
                                    </span>
                                  </div>
                                  <div className="score-info">
                                    <span className="score-value">{entry.score}</span>
                                    <span className="difficulty-badge">{entry.difficulty}</span>
                                  </div>
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div className="no-scores">No scores yet. Be the first!</div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }); // Close React.memo

        // Responsive canvas sizing hook with debouncing and memoization
        function useCanvasSize(GRID) {
          const compute = React.useMemo(() => {
            return () => {
              const vw = Math.max(320, Math.min(1024, window.innerWidth));
              const max = vw - 32;
              const target = Math.min(560, max);
              const cell = Math.max(12, Math.floor(target / GRID));
              const size = cell * GRID;
              return [size, cell];
            };
          }, [GRID]);

          const [state, setState] = useState(compute());
          
          useEffect(() => {
            let timeoutId = null;
            
            const onResize = () => {
              // Debounce resize events for better performance
              if (timeoutId) clearTimeout(timeoutId);
              timeoutId = setTimeout(() => {
                setState(compute());
              }, 16); // ~60fps throttling
            };
            
            window.addEventListener('resize', onResize, { passive: true });
            return () => {
              window.removeEventListener('resize', onResize);
              if (timeoutId) clearTimeout(timeoutId);
            };
          }, [compute]);
          
          return state;
        }

        // Profiler-wrapped component for performance monitoring  
        const ProfiledGame = () => React.createElement(
          Profiler, 
          { id: 'NeonCyberSnake', onRender: onRenderCallback },
          React.createElement(NeonCyberSnake)
        );

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(ProfiledGame));
    </script>
</body>
</html>